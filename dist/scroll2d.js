var e={};function t(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function i(e){let t;return 6==e.length||7==e.length?(t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e),t?{a:255,r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null):8==e.length||9==e.length?(t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e),t?{a:parseInt(t[1],16),r:parseInt(t[2],16),g:parseInt(t[3],16),b:parseInt(t[4],16)}:null):{a:255,r:0,g:0,b:0}}function o(e,t,i,o){return Math.sqrt((e-i)**2+(t-o)**2)}function n(e,t){const i=e.indexOf(t);return i>-1&&e.splice(i,1),e}e.d=(t,i)=>{for(var o in i)e.o(i,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:i[o]})},e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);let s=null,r=null;function l(e){if(!e||!e.element)return;const t=e.element;let i=!1;e.ignoreOut&&(i=!0),a(t),t.addEventListener("touchstart",function(e){e.preventDefault(),e.stopPropagation()},{passive:!1}),t.addEventListener("pointerdown",function(i){i.preventDefault(),i.stopPropagation();let o="mouse";i.pointerType&&(o=i.pointerType);let n=1;i.pressure&&(n=i.pressure);let s=1;return"mouse"==o&&i.which&&(s=i.which),e.down&&e.down({element:t,id:i.pointerId,x:i.offsetX,y:i.offsetY,type:o,pressure:n,which:s,pageX:i.pageX,pageY:i.pageY}),!1},{passive:!1}),t.addEventListener("pointermove",function(i){i.preventDefault(),i.stopPropagation();let o="mouse";i.pointerType&&(o=i.pointerType);let n=1;i.pressure&&(n=i.pressure);let s=1;return"mouse"==o&&i.which&&(s=i.which),e.move&&e.move({element:t,id:i.pointerId,x:i.offsetX,y:i.offsetY,type:o,pressure:n,which:s,pageX:i.pageX,pageY:i.pageY}),!1},{passive:!1}),i||t.addEventListener("pointerout",function(i){i.preventDefault(),i.stopPropagation();let o="mouse";i.pointerType&&(o=i.pointerType);let n=1;return"mouse"==o&&i.which&&(n=i.which),e.up&&e.up({element:t,id:i.pointerId,type:o,which:n,evt:"out"}),!1},{passive:!1}),t.addEventListener("pointerup",function(i){i.preventDefault(),i.stopPropagation();let o="mouse";i.pointerType&&(o=i.pointerType);let n=1;return"mouse"==o&&i.which&&(n=i.which),e.up&&e.up({element:t,id:i.pointerId,type:o,which:n,evt:"up"}),!1},{passive:!1})}function a(e){e.addEventListener("contextmenu",function(e){return e.preventDefault(),e.stopPropagation(),!1},{passive:!1}),e.addEventListener("ontouchforcechange",function(e){return e.preventDefault(),e.stopPropagation(),!1},{passive:!1}),e.addEventListener("webkitmouseforcewillbegin",function(e){e.preventDefault(),e.stopPropagation()},{passive:!1}),e.addEventListener("webkitmouseforcedown",function(e){e.preventDefault(),e.stopPropagation()},{passive:!1}),e.addEventListener("webkitmouseforceup",function(e){e.preventDefault(),e.stopPropagation()},{passive:!1}),e.addEventListener("webkitmouseforcechanged",function(e){e.preventDefault(),e.stopPropagation()},{passive:!1}),e.touchAction="none",e.contentZooming="none",e.msTouchAction="none",e.msContentZooming="none",e.style.touchAction="none",e.style.userSelect="none"}function h(){null!=r&&clearTimeout(r),s=null,r=null}window.apeApps||(window.apeApps={}),window.apeApps.utilities||(window.apeApps.utilities={}),window.apeApps.utilities.inputHelper={handleInput:function(e,t,i,o,n=!1){console.warn("apeApps.utilities.inputHelper.handleInput is deprecated. Please use module instead."),l({element:e,down:function(e){t(e.element,e.id,e.x,e.y,e.type,e.pressure,e.which,e.pageX,e.pageY)},move:function(e){i(e.element,e.id,e.x,e.y,e.type,e.pressure,e.which,e.pageX,e.pageY)},up:function(e){o(e.element,e.id,e.type,e.which,e.evt)},ignoreOut:n})},clearElementForTouch:a,clickAndContextHelper:function(e){if(!e||!e.element)return;const t=e.element;let i=!0;if(null!=e.vibrate&&(i=e.vibrate),/iPad|iPhone|iPod/.test(navigator.userAgent)){let o=null;t.ontouchstart=function(n){n.preventDefault(),n.stopPropagation(),o="down",s=t,r=setTimeout(function(){null!=s&&(s.touchStatus="up",i&&navigator.vibrate&&navigator.vibrate(100),e.context&&e.context({element:t,x:n.pageX,y:n.pageY})),h()},600)},t.ontouchend=function(i){i.preventDefault(),i.stopPropagation();const n=o;if(o="up",h(),"down"==n){let o=t;i.target&&(o=i.target),e.click&&e.click({element:o,x:i.pageX,y:i.pageY})}},t.ontouchcancel=function(e){e.preventDefault(),e.stopPropagation(),o="up",h()},t.ontouchmove=function(e){e.preventDefault(),e.stopPropagation(),o="up",h()}}else t.onclick=function(i){i.preventDefault(),i.stopPropagation();let o=t;i.target&&(o=i.target),e.click&&e.click({element:o,x:i.pageX,y:i.pageY})},t.oncontextmenu=function(o){o.preventDefault(),o.stopPropagation(),i&&navigator.vibrate&&navigator.vibrate(50),e.context&&e.context({element:t,x:o.clientX,y:o.clientY})}}};const c=[],d=2*Math.PI,p=Math.PI/180;class u{constructor(){this.particles=[],this.offsetX=0,this.offsetY=0,this.middleX=0,this.middleY=0,this.starfieldStarSize=.3,this.starfieldAcceleration=.015,this.starfieldSpeed=.125,this.starfieldTrails=!1,this.starfieldMaxHoldoff=289,this.starfieldGrowth=.00375,this.starfieldPasses=1,this.starfieldColor="#ffffff",this.starfieldRunning=!1,this.rainRunning=!1,this.snowRunning=!1,this.embersRunning=!1,this.rndAngle=0,this.acceleration=0}update(e){(!e||e>20)&&(e=1);let i,o,s,r,l=[],a=[];this.rndAngle+=.002*e;let h=2*(this.middleX-this.offsetX),d=2*(this.middleY-this.offsetY);if(this.starfieldRunning)for(let e=0;e<this.starfieldPasses;e++){let e=t(this.offsetX,h),i=t(this.offsetY,d),o=Math.sqrt(e*e+i*i),n=this.starfieldSpeed/o,s=n*e,r=n*i;1==t(1,2)&&(s=-s),1==t(1,2)&&(r=-r);let l=this.starfieldColor;Array.isArray(this.starfieldColor)&&(l=this.starfieldColor[t(0,this.starfieldColor.length-1)]),a.push({x:this.middleX,y:this.middleY,vx:s,vy:r,size:this.starfieldStarSize,growth:this.starfieldGrowth,color:l,alpha:0,fade:-.025,gravityX:0,gravityY:0,compOp:"screen",trails:this.starfieldTrails,acceleration:this.starfieldAcceleration,holdoffTicks:t(0,this.starfieldMaxHoldoff)})}if(this.rainRunning){let e=t(1,3);for(let i=0;i<e;i++)o=t(this.offsetX,this.offsetX+h),s=t(1,3),s-=.5,r=t(6,14),a.push({x:o,y:this.offsetY,vx:0,vy:r,size:s,color:"#42A5F5",alpha:.3,compOp:"screen",fade:0,trails:!0})}if(this.snowRunning&&2==t(0,5)&&(o=t(this.offsetX,this.offsetX+h),s=t(1,3),s-=.5,r=t(1,6),a.push({x:o,y:this.offsetY,vx:2*Math.sin(this.rndAngle),vy:r,size:s,color:"#ffffff",alpha:.8,compOp:"screen",fade:0,loopsBack:!0,useGlobalAngle:!0})),this.embersRunning&&2==t(0,5)){o=t(this.offsetX,this.offsetX+h),s=t(1,2),s-=.5,r=-t(1,2);let e=2*Math.sin(this.rndAngle);a.push({x:o,y:2*this.middleY,vx:e,vy:r,size:s,color:"#EF6C00",alpha:.6,compOp:"screen",fade:0,loopsBack:!0,useGlobalAngle:!0}),a.push({x:o,y:2*this.middleY,vx:e,vy:r,size:s-.25,color:"#FFECB3",alpha:.85,compOp:"screen",fade:0,loopsBack:!0,useGlobalAngle:!0})}for(let t=0,o=this.particles.length;t<o;t++){if(i=this.particles[t],i.holdoffTicks>0&&(i.holdoffTicks-=e),i.age+=e,null!=i.speed&&null!=i.angle){let e=i.angle*p;i.vx=Math.cos(e)*i.speed,i.vy=Math.sin(e)*i.speed+i.gravityY}i.useGlobalAngle?i.x+=2*Math.sin(this.rndAngle)*e:i.x+=i.vx*e,i.y+=i.vy*e,i.size+=i.growth*e,i.alpha-=i.fade*e,i.vx+=i.gravityX*e,i.vy+=i.gravityY*e,i.alpha<=0||i.size<=0||i.dead?l.push(i):(i.alpha>1&&(i.alpha=1),i.trails&&i.alpha>0&&i.holdoffTicks<=0&&a.push({x:i.x,y:i.y,color:i.color,vx:0,vy:0,gravityX:0,gravityY:0,fade:.25,size:i.size,growth:0,alpha:i.alpha}),i.acceleration>0&&(i.vx+=i.vx*(i.acceleration*e),i.vy+=i.vy*(i.acceleration*e)))}for(;l.length>0;){let e=l.pop();n(this.particles,e),c.length<4e3&&c.push(e)}for(;a.length>0;){let e=a.pop();this.playParticle(e)}}draw(e){let t;e.save(),0==this.offsetX&&0==this.offsetY||e.translate(this.offsetX,this.offsetY);let i=e.canvas;this.middleX=this.offsetX+i.width/2,this.middleY=this.offsetY+i.height/2;for(let o=0,n=this.particles.length;o<n;o++)if(t=this.particles[o],!(t.holdoffTicks>0)){if(t.age>100){if(t.y<this.offsetY||t.y>this.offsetY+i.height){t.dead=!0;continue}if(t.x<this.offsetX||t.x>this.offsetX+i.width){if(!t.loopsBack){t.dead=!0;continue}t.x<this.offsetX?t.x=this.offsetX+i.width:t.x=this.offsetX}}e.save(),e.globalCompositeOperation=t.compOp,e.globalAlpha=t.alpha,e.beginPath(),e.arc(t.x,t.y,t.size,0,d,!1),e.fillStyle=t.color,e.fill(),e.restore()}i=null,e.restore()}reset(){this.particles=[]}playParticle(e){if(this.particles.length>4e3)return;const i=function(e){if(0==c.length)return new g(e);{let i=c.pop();if(!i)return new g(e);i.x=0,i.y=0,i.vx=0,i.vy=0,i.size=1,i.growth=0,i.color="#ff0000",i.alpha=1,i.dead=!1,i.fade=.01,i.age=0,i.gravityX=0,i.gravityY=0,i.compOp="lighter",i.trails=!1,i.loopsBack=!1,i.useGlobalAngle=!1,i.sticks=!1,i.holdoffTicks=0,i.acceleration=0;let o=0,n=0,s=0,r=0;if(e)for(let l in e)"rSize"==l&&(i.size=t(e[l][0],e[l][1])),"rGrowth"==l&&(i.growth=t(e[l][0],e[l][1])),"xDev"!=l&&"yDev"!=l?"rVX"!=l&&"rVY"!=l?i[l]=e[l]:("rVX"==l&&(s=t(0,2*e[l]),s-=e[l]),"rVY"==l&&(r=t(0,2*e[l]),r-=e[l])):("xDev"==l&&(o=t(0,2*e[l]),o-=e[l]),"yDev"==l&&(n=t(0,2*e[l]),n-=e[l]));return i.x+=o,i.y+=n,i.vx+=s,i.vy+=r,i}}(e);this.particles.push(i)}playEffect(e,i,o){if(!f[e])return;let n=f[e];for(let s=0;s<n.length;s++){let r=0;(e=n[s]).count&&(r=e.count),e.rCount&&(r=t(e.rCount[0],e.rCount[1]));for(let n=0;n<r;n++){let n=i,s=o;if(e.prX){let i=t(0,2*e.prX);i-=e.prX,n+=i}if(e.prY){let i=t(0,2*e.prY);i-=e.prY,s+=i}if(null==e.program){let t={};for(let i in e.options)t[i]=e.options[i];t.x=n,t.y=s,this.playParticle(t)}else this.playEffect(e.program,n,s)}}}}class g{constructor(e){this.x=0,this.y=0,this.vx=0,this.vy=0,this.size=1,this.growth=0,this.color="#ff0000",this.alpha=1,this.dead=!1,this.fade=.01,this.age=0,this.gravityX=0,this.gravityY=0,this.compOp="lighter",this.trails=!1,this.loopsBack=!1,this.useGlobalAngle=!1,this.sticks=!1,this.speed=null,this.angle=null,this.holdoffTicks=0;let i=0,o=0,n=0,s=0;if(this.acceleration=0,e)for(let r in e)"rSpeed"!=r?"rAngle"!=r?"xDev"!=r&&"yDev"!=r?"rVX"!=r&&"rVY"!=r?this[r]=e[r]:("rVX"==r&&(n=t(0,2*e[r]),n-=e[r]),"rVY"==r&&(s=t(0,2*e[r]),s-=e[r])):("xDev"==r&&(i.middleXv=t(0,2*e[r]),i-=e[r]),"yDev"==r&&(o=t(0,2*e[r]),o-=e[r])):this.angle=t(e[r][0],e[r][1]):this.speed=t(e[r][0],e[r][1]);this.x+=i,this.y+=o,this.vx+=n,this.vy+=s}}const f={redblast:[{count:14,program:null,options:{rSize:[1,3],color:"#E53935",rVX:8,rVY:8}}],blueblast:[{count:3,program:null,options:{size:7,color:"#1976D2",rVX:2,vy:0,rGrowth:[0,1]}}],yellowblast:[{rCount:[0,1],program:null,options:{rSize:[1,2],color:"#1976D2",rVX:12,rVY:4}},{rCount:[0,1],program:null,options:{rSize:[1,2],color:"#FFB300",rVX:12,rVY:4}},{rCount:[0,1],program:null,options:{rSize:[1,2],color:"#FF6F00",rVX:12,rVY:4}}],purpleblast:[{rCount:[0,1],program:null,options:{rSize:[1,3],color:"#E91E63",rVX:6,rVY:6,sticks:!0}},{rCount:[0,1],program:null,options:{rSize:[1,3],color:"#9C27B0",rVX:6,rVY:6,sticks:!0}},{rCount:[0,1],program:null,options:{rSize:[1,3],color:"#F44336",rVX:6,rVY:6,sticks:!0}}],stab:[{count:1,program:null,options:{size:4,color:"#660000",fade:.02,compOp:"source-over"}}],smallmagic:[{count:1,program:null,options:{size:6,color:"#007acc",fade:.02,compOp:"source-over"}}],leaf:[{count:1,program:null,options:{size:8,color:"#00994d",fade:.02,compOp:"source-over"}}],blunt:[{count:1,program:null,options:{size:16,color:"#333333",fade:.02,compOp:"source-over"}}],bluntspike:[{count:1,program:"blunt",options:null},{count:1,program:"shotgun",options:null}],shotgun:[{count:12,program:null,options:{size:4,color:"#660000",fade:.02,compOp:"source-over",xDev:30,yDev:30}}],explosion:[{count:40,program:null,options:{size:3,color:"#ff9900",fade:.02,rVX:5,rVY:5,growth:-.05}},{count:10,program:null,options:{size:5,color:"#ffe0b3",fade:.02,rVX:5,rVY:5,trails:!0,alpha:.8}},{count:10,program:null,options:{size:1,color:"#ffff66",fade:.04,rVX:5,rVY:5,trails:!0,alpha:.5,growth:.3}},{count:20,program:null,options:{size:1,color:"#ffff66",fade:.01,rVX:5,rVY:5,gravityY:.05,trails:!0,alpha:.5,growth:.05,useGlobalAngle:!0}}],sonicexplosion:[{count:40,program:null,options:{size:5,color:"#000099",fade:.02,rVX:5,rVY:5}},{count:10,program:null,options:{size:5,color:"#660066",fade:.02,rVX:5,rVY:5}},{count:10,program:null,options:{size:5,color:"#9966ff",fade:.02,rVX:5,rVY:5}}],blueexplosion:[{count:40,program:null,options:{rSize:[1,3],color:"#002080",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:10,program:null,options:{rSize:[2,4],color:"#002db3",fade:.02,rSpeed:[1,5],rAngle:[0,360]}},{count:10,program:null,options:{rSize:[3,6],color:"#0039e6",fade:.02,rSpeed:[1,5],rAngle:[0,360]}}],bloodexplosion:[{count:40,program:null,options:{size:5,color:"#F44336",fade:.02,compOp:"source-over",rVX:5,rVY:5}},{count:10,program:null,options:{size:5,color:"#E53935",compOp:"source-over",fade:.02,rVX:5,rVY:5}},{count:10,program:null,options:{size:5,color:"#D32F2F",compOp:"source-over",fade:.02,rVX:5,rVY:5}}],multiexplosion:[{count:0,rCount:[3,8],program:"explosion",options:null,prX:150,prY:150}],flame:[{count:6,program:null,prX:4,prY:2,options:{size:1,color:"#FFD54F",fade:.02,vy:-.6,rvX:20,growth:.15}}],smallrainbowexplosion:[{count:8,program:null,options:{rSize:[1,5],color:"#f44336",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#FF9800",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#FFEB3B",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#4CAF50",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#2196F3",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#3F51B5",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#673AB7",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}}],smallelectricexplosion:[{count:8,program:null,options:{rSize:[1,5],color:"#B3E5FC",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#BBDEFB",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#42A5F5",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#29B6F6",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#1976D2",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#0288D1",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#01579B",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}}],explosionpinks:[{count:40,program:null,options:{size:3,color:"#F8BBD0",fade:.02,rVX:5,rVY:5,growth:-.05}},{count:10,program:null,options:{size:5,color:"#F48FB1",fade:.02,rVX:5,rVY:5,trails:!0,alpha:.8}},{count:10,program:null,options:{size:1,color:"#F06292",fade:.04,rVX:5,rVY:5,trails:!0,alpha:.5,growth:.3}},{count:20,program:null,options:{size:1,color:"#EC407A",fade:.01,rVX:5,rVY:5,gravityY:.05,trails:!0,alpha:.5,growth:.05,useGlobalAngle:!0}}],explosionpindogos:[{count:40,program:null,options:{size:3,color:"#C5CAE9",fade:.02,rVX:5,rVY:5,growth:-.05}},{count:10,program:null,options:{size:5,color:"#9FA8DA",fade:.02,rVX:5,rVY:5,trails:!0,alpha:.8}},{count:10,program:null,options:{size:1,color:"#7986CB",fade:.04,rVX:5,rVY:5,trails:!0,alpha:.5,growth:.3}},{count:20,program:null,options:{size:1,color:"#5C6BC0",fade:.01,rVX:5,rVY:5,gravityY:.05,trails:!0,alpha:.5,growth:.05,useGlobalAngle:!0}}],explosionlightblues:[{count:40,program:null,options:{size:3,color:"#B3E5FC",fade:.02,rVX:5,rVY:5,growth:-.05}},{count:10,program:null,options:{size:5,color:"#81D4FA",fade:.02,rVX:5,rVY:5,trails:!0,alpha:.8}},{count:10,program:null,options:{size:1,color:"#4FC3F7",fade:.04,rVX:5,rVY:5,trails:!0,alpha:.5,growth:.3}},{count:20,program:null,options:{size:1,color:"#29B6F6",fade:.01,rVX:5,rVY:5,gravityY:.05,trails:!0,alpha:.5,growth:.05,useGlobalAngle:!0}}]},v=function(){return new u};window.addEventListener("resize",D);const m=Math.PI,S=2*m,w=m/180,x=.001,y=1e3/60,z={},C=[],G=[],X=[];let R=null,Y=0;function M(e){const t=new F(e);return z[t.id]=t,t}class F{constructor(e){const t=this;this.id=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}(),this.scale=e.scale||window.devicePixelRatio||1,this.autoScale=!0,e.scale&&(this.autoScale=!1),this.lastScale=this.scale,this.drawQueue=[],this.aboveFoldDrawQueue=[],this.textPoppers=[],this.lightBlockers=[],this.lightSources=[],this.selectionColor=e.selectionColor||"#4CAF50",this.running=!1,this.changed=!0,this.staticCallMade=!1,this.isometricMode=e.isometricMode||!1,this.fitGridToHeight=e.fitGridToHeight||!1,this.staticMapInit=!1,this.didAMove=!1,this.didMove=!1,this.isDown=!1,this.isHold=!1,this.usingTouch=!1,this.isSelection=!1,this.nextDownSelection=!1,this.usingMouse=!1,this.isPainting=!1,this.isPinching=!1,this.instructionsRecieved=!1,this.doubleHeightTiles=e.doubleHeightTiles||!1,this.useFastRenderMode=e.fastRenderMode||!1,this.pixelated=e.pixelated||!1,this.fullMapRenderCallback=null,this.colorFilter=null,this.filterAmount=0,this.darknessMaskColor=null,this.viewX=0,this.viewY=0,this.actualX=0,this.actualY=0,this.startX=0,this.startY=0,this.holdX=0,this.holdY=0,this.curX=0,this.curY=0,this.selectionX=0,this.selectionY=0,this.selectionTopX=0,this.selectionTopY=0,this.selectionWidth=0,this.selectionHeight=0,this.lastHoverX=0,this.lastHoverY=0,this.lastPaintX=0,this.lastPaintY=0,this.lerpX=0,this.lerpY=0,this.lerpCallback=null,this.lerpSpeed=.15,this.lerpAccuracy=1,this.viewPadding=0,this.zoomLevel=1,this.fpsLimiter=e.fpsLimiter||1,this.fpsCounter=0,this.maxZoom=e.maxZoom||3,this.minZoom=e.minZoom||.1,this.width=0,this.height=0,this.winWidth=0,this.winHeight=0,this.mapWidth=-1,this.mapHeight=-1,this.mapTotalWidth=-1,this.mapTotalHeight=-1,this.gridSize=e.gridSize||40,this.relativeGridSize=this.gridSize,this.halfGridSize=this.gridSize/2,this.halfRelativeGridSize=this.relativeGridSize/2,this.quarterRelativeGridSize=this.relativeGridSize/4,this.twentiethGridSize=this.relativeGridSize/20,this.renderOrder=0,this.staticMaxZIndex=1,this.lastDistance=null,this.pointerListener=e.onPointer||null,this.holdFunction=e.onHold||null,this.selectionFunction=e.onSelection||null,this.selectionProgressFunction=e.onSelectionProgress||null,this.hoverFunction=e.onHover||null,this.paintFunction=e.onPaint||null,this.viewportChangeFunction=e.onViewportChange||null,this.releaseFunction=e.onRelease||null,this.clickFunction=e.onClick||null,this.rightClickFunction=e.onRightClick||null,this.drawFunction=e.onDraw||null,this.updateFunction=e.onUpdate||null,this.paintTimer=null,this.paintTimeoutFunction=null,this.screenshotCanvas=null,this.screenshotContext=null,this.screenshotCallback=null,this.screenshotPhase=!1,this.particleEngine=null,this.holdTimer=null,this.staticMap={},this.limits={xMin:0,xLimit:0,yMin:0,yLimit:0},this.mouseScrolling={up:!1,down:!1,left:!1,right:!1},this.padScrolling={up:!1,down:!1,left:!1,right:!1},this.padRightScrolling={up:!1,down:!1,left:!1,right:!1},this.padTriggers={left:!1,right:!1},this.aDownTime=0,this.pointers={},this.primaryPointer=null,this.pointersDown=0;const i=e.logicFPS||60;this.updateTime=1e3/i,this.lastUpdateUpdate=0,this.gamepadNegotiationTimer=0,this.viewBounds=null,this.holder=null,e.holder?this.holder=e.holder:(this.holder=document.createElement("div"),this.holder.classList.add("scroll2d-holder"),W(this.holder),document.body.appendChild(this.holder)),this.lightCanvas=document.createElement("canvas"),this.lightFinalRenderCanvas=document.createElement("canvas"),this.staticCanvas=document.createElement("canvas"),this.preRenderCanvas=document.createElement("canvas"),this.gradientFilterCanvas=document.createElement("canvas"),this.canvas=document.createElement("canvas"),this.filterOverlay=document.createElement("div"),this.context=this.canvas.getContext("2d"),this.staticContext=this.staticCanvas.getContext("2d"),this.lightContext=this.lightCanvas.getContext("2d"),this.lightFinalRenderContext=this.lightFinalRenderCanvas.getContext("2d"),this.preRenderContext=this.preRenderCanvas.getContext("2d"),this.gradientFilterContext=this.gradientFilterCanvas.getContext("2d"),this.pixelated&&(oe(this.canvas),oe(this.staticCanvas),oe(this.lightCanvas),oe(this.lightFinalRenderCanvas),oe(this.preRenderCanvas),oe(this.gradientFilterCanvas)),this.holder.appendChild(this.canvas),this.holder.appendChild(this.filterOverlay),a(this.canvas),l({element:t.filterOverlay,down:function(e){!function(e,t){let i=t.x,o=t.y,n=i,s=o;e.didAMove=!1,"touch"==t.type?e.usingTouch=!0:e.usingTouch=!1;const r=e.getPointer(t.id,n,s,t.type);r.down=!0,e.pointersDown++,e.isSelection=!1,e.nextDownSelection&&(e.isSelection=!0,e.nextDownSelection=!1),e.actualX=n,e.actualY=s,"mouse"==t.type?(e.usingMouse=!0,t.which&&1!=t.which?r.rightClick=!0:r.rightClick=!1):e.usingMouse=!1,e.pointerListener&&e.pointerListener("down",i,o,t.type,t.which),e.startX=i,e.startY=o,e.didMove=!1,e.isDown=!0,e.isHold=!1,(e.holdFunction||e.selectionFunction)&&(e.holdX=i,e.holdY=o,r.rightClick||e.isSelection?e.selectionFunction&&e.isSelection&&I(e):e.holdTimer=setTimeout(function(){if(e.holdTimer=null,e.didMove=!1,!e.isPainting)if(e.selectionFunction)I(e);else if(e.holdFunction){e.isHold=!0;const t=e.positionToCoords(e.holdX,e.holdY);e.holdFunction(t.x,t.y)}},700)),e.pointersDown>1&&(e.isSelection=!1,e.holdTimer&&(clearTimeout(e.holdTimer),e.holdTimer=null))}(t,e)},move:function(e){!function(e,t){"touch"==t.type?e.usingTouch=!0:e.usingTouch=!1;const i=e.getPointer(t.id,t.x,t.y,t.type);i.down=!0,e.actualX=t.x,e.actualY=t.y,"mouse"==t.type?e.usingMouse=!0:e.usingMouse=!1;let n=t.x,s=t.y;if(e.pointerListener&&e.pointerListener("move",n,s,t.type,t.which),i.x=n,i.y=s,2==e.pointersDown)return e.didMove=!0,void function(e){if(2!=e.pointersDown||!e.primaryPointer)return;let t,i;for(const o in e.pointers){const n=e.pointers[o];n.down&&(t?i||(i=n):t=n)}if(!t||!i)return;e.isSelection=!1;const n=o(t.x,t.y,i.x,i.y);null!=e.lastDistance?(n>e.lastDistance+3&&(e.doZoom(!0),e.lastDistance=n),n<e.lastDistance-3&&(e.doZoom(!1),e.lastDistance=n)):e.lastDistance=n}(e);let r=0,l=0;e.curX&&(r=e.curX,l=e.curY),e.curX=n,e.curY=s;const a=e.positionToCoords(n,s);if("mouse"!=t.type&&"pen"!=t.type||!e.hoverFunction||(e.lastHoverX=a.x,e.lastHoverY=a.y,e.hoverFunction(a.x,a.y,e.actualX,e.actualY,t.type,a.px,a.py)),e.isDown&&!e.isHold){if(e.isSelection)return e.setSelectionPoints(n,s),void(e.selectionProgressFunction&&e.sendSelectionPointsToFunction(e.selectionProgressFunction));if(e.didMove){if(e.changed=!0,e.isPainting&&e.paintFunction){if(e.lastPaintX==a.x&&e.lastPaintY==a.y)return;return e.lastPaintX=a.x,e.lastPaintY=a.y,void e.paintFunction(a.x,a.y,e.actualX,e.actualY,t.type)}e.didAMove=!0;const i=r-e.curX,o=l-e.curY;e.viewX+=i,e.viewY+=o,e.checkBounds(),e.notifyViewportChange(!0)}else{const t=o(e.startX,e.startY,n,s);let i=6;e.usingTouch&&(i=12),t>i&&(e.didMove=!0,e.holdTimer&&(clearTimeout(e.holdTimer),e.holdTimer=null,e.isHold=!1))}}}(t,e)},up:function(e){!function(e,t){e.didAMove&&(e.didAMove=!1),"touch"==t.type?e.usingTouch=!0:e.usingTouch=!1;const i=e.getPointer(t.id,null,null,t.type);if(i.down&&(e.pointersDown--,i.down=!1),e.holdTimer&&(clearTimeout(e.holdTimer),e.holdTimer=null,e.isHold=!1),i.primary&&(i.primary=!1,e.primaryPointer=null),e.isPinching&&(e.isSelection=!1),e.isPinching=!1,e.isDown){if(e.isHold)return e.isDown=!1,void(e.releaseFunction&&e.releaseFunction());if(e.isPainting=!1,e.pointersDown<=0&&(e.pointers={},e.pointersDown=0,e.primaryPointer=null,e.lastDistance=null),e.isSelection)!function(e){e.isSelection=!1,e.isDown=!1,e.selectionFunction&&e.sendSelectionPointsToFunction(e.selectionFunction)}(e);else{if(!e.didMove&&e.clickFunction){const o=e.positionToCoords(e.startX,e.startY);e.isSelection=!1,e.isDown=!1,e.pointersDown=0;const n=e.actualX,s=e.actualY;"touch"==t.type?setTimeout(function(){e.clickFunction(o.x,o.y,n,s,t.type,o.px,o.py)},75):(i.rightClick&&e.rightClickFunction?e.rightClickFunction(o.x,o.y,n,s,t.type,o.px,o.py):e.clickFunction(o.x,o.y,n,s,t.type,o.px,o.py),i.rightClick=!1)}e.pointerListener&&e.pointerListener("up",0,0,t.type,t.which),e.isDown=!1,e.didMove=!1,e.actualX=0,e.actualY=0}}}(t,e)}}),this.filterOverlay.addEventListener("wheel",function(e){e.preventDefault(),function(e,t){if(!e.usingMouse)return;const i=function(e){let t=0,i=0,o=0,n=0;return"detail"in e&&(i=e.detail),"wheelDelta"in e&&(i=-e.wheelDelta/120),"wheelDeltaY"in e&&(i=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),"axis"in e&&e.axis===e.HORIZONTAL_AXIS&&(t=i,i=0),o=10*t,n=10*i,"deltaY"in e&&(n=e.deltaY),"deltaX"in e&&(o=e.deltaX),(o||n)&&e.deltaMode&&(1==e.deltaMode?(o*=40,n*=40):(o*=800,n*=800)),o&&!t&&(t=o<1?-1:1),n&&!i&&(i=n<1?-1:1),{pinX:t,spinY:i,pixelX:o,pixelY:n}}(t);t.deltaY<0&&e.doZoom(!0,i.spinY),t.deltaY>0&&e.doZoom(!1,i.spinY)}(t,e)}),W(this.canvas),W(this.filterOverlay),this.normalizeFilterOverlaySize(),this.gamepadAllStop(),setTimeout(function(){t.running=!0,t.resize()},200)}destroy(){this.running=!1,this.holder.innerHTML="",delete z[this.id]}render(e){!function(e,t){if(!e.running)return;(isNaN(t)||null==t)&&(t=1),e.autoScale&&(e.scale=window.devicePixelRatio||1),e.scale!=e.lastScale&&V(e),e.lastScale=e.scale,e.renderOrder=0,e.lightBlockers=[],e.particleEngine&&e.particleEngine.update(t);for(const i of e.textPoppers)i.cashed||(i.y-=2*t,i.alpha-=.01*t);let s=null,r=null;if(e.fullMapRenderCallback){const t=e.mapWidth*e.gridSize,i=e.mapHeight*e.gridSize;s=document.createElement("canvas"),r=s.getContext("2d"),e.pixelated&&oe(s),s.width=t/2,s.height=i/2,e.isometricMode&&(s.height=i/4)}e.fpsCounter++;let l=e.fpsLimiter;const a=e.drawQueue.length+e.aboveFoldDrawQueue.length;if(a>1e3?l=Math.max(e.fpsLimiter,3):a>500&&(l=Math.max(e.fpsLimiter,2)),e.fpsCounter<l)return;if(e.fpsCounter=0,e.instructionsRecieved=!1,e.drawFunction){let t=!1;r&&(t=!0),e.drawFunction(t)}if(!e.instructionsRecieved)return;if(e.changed&&(e.staticContext.clearRect(0,0,e.width,e.height),e.staticContext.save(),e.staticContext.translate(-e.viewX,-e.viewY),function(e,t){if(!e.staticCallMade)return;e.viewBounds||e.setViewBounds();let i=e.viewBounds.minX,o=e.viewBounds.minY,n=e.viewBounds.maxX,s=e.viewBounds.maxY;t&&(i=0,o=0,n=e.mapWidth,s=e.mapHeight);for(let t=0;t<=e.staticMaxZIndex;t++)for(let r=i;r<=n;r++)for(let i=o;i<=s;i++){const o=e.getStaticItem(r,i,t);o&&o.img&&e.staticContext.drawImage(o.img,o.x,o.y,o.w,o.h)}}(e,r),e.staticContext.restore(),e.changed=!1),e.context.clearRect(0,0,e.width,e.height),e.context.globalCompositeOperation="source-over",e.staticCanvas&&e.staticCanvas.width>0&&(e.context.save(),e.context.setTransform(1,0,0,1,0,0),e.context.drawImage(e.staticCanvas,0,0,e.width,e.height),e.context.restore()),e.drawQueue.length>0)for((!e.useFastRenderMode||e.drawQueue.length<200)&&e.drawQueue.sort(B);e.drawQueue.length>0;){const t=e.drawQueue.pop();O(e,t,e.context,r),C.push(t)}if(e.context.globalAlpha=1,e.lightSources.length>0||null!=e.colorFilter){if(null!=e.colorFilter&&e.filterAmount>0){const t=i(e.colorFilter);e.darknessMaskColor="rgba("+t.r+","+t.g+","+t.b+","+e.filterAmount+")"}else e.darknessMaskColor=null;let t="rgba(255,255,255,0)";for(null!=e.darknessMaskColor&&(t=e.darknessMaskColor),e.lightContext.fillStyle=t,e.lightContext.clearRect(0,0,e.width,e.height),e.lightContext.fillRect(0,0,e.width,e.height),e.lightFinalRenderContext.clearRect(0,0,e.width,e.height);e.lightSources.length>0;){const t=e.lightSources.pop(),i=t.x-e.viewX+.5|0,o=t.y-e.viewY+.5|0,n=t.radius;Z(e,e.lightContext,i,o,n,"rgba("+t.color.r+","+t.color.g+","+t.color.b+","+t.intensity+")","rgba("+t.color.r+","+t.color.g+","+t.color.b+",0)"),X.push(t)}e.context.save(),e.context.globalCompositeOperation="multiply",e.context.drawImage(e.lightCanvas,0,0),e.context.restore()}if(e.aboveFoldDrawQueue.length>0)for(e.aboveFoldDrawQueue.sort(B);e.aboveFoldDrawQueue.length>0;){const t=e.aboveFoldDrawQueue.pop();O(e,t,e.context,r),C.push(t)}e.particleEngine&&e.particleEngine.draw(e.context),e.screenshotPhase&&(e.screenshotPhase=!1,e.changed=!0,e.screenshotContext.drawImage(e.canvas,0,0),e.screenshotCallback&&e.screenshotCallback(e.screenshotCanvas),e.screenshotCanvas=null,e.screenshotContext=null,e.screenshotCallback=null);const h=[];for(const t of e.textPoppers)t.cashed?h.push(t):E(e,e.context,t);for(;h.length>0;){const t=h.pop();n(e.textPoppers,t),G.push(t)}if(e.isSelection&&!e.isPinching&&(e.context.save(),e.context.globalAlpha=1,e.context.lineWidth=4,e.context.strokeStyle=e.selectionColor,e.context.strokeRect(e.selectionTopX,e.selectionTopY,e.selectionWidth,e.selectionHeight),e.context.restore()),e.fullMapRenderCallback&&s){const t=e.fullMapRenderCallback,i=new Image;i.onload=function(){t(i)},i.src=s.toDataURL("image/png")}if(e.fullMapRenderCallback=null,e.lerpCallback){const t=e.getCenterPosition();if(o(t.px,t.py,e.lerpX,e.lerpY)<e.lerpAccuracy){const t=e.lerpCallback;e.lerpX=0,e.lerpY=0,e.lerpCallback=null,e.lerpSpeed=.15,e.lerpAccuracy=1,t()}else{let i=(e.lerpX-t.px)*e.lerpSpeed,o=(e.lerpY-t.py)*e.lerpSpeed;i>0&&i<x&&(i=x),i<0&&i>-.001&&(i=-.001),o>0&&o<x&&(o=x),o<0&&o>-.001&&(o=-.001);const n=t.px+i,s=t.py+o;e.centerOnCoord(n,s)}}}(this,e)}resize(){V(this)}setMapDimensions(e,t){if(this.mapWidth=e,this.mapHeight=t,null==e||null==t||e<0||t<0)return this.mapWidth=-1,this.mapHeight=-1,this.mapTotalWidth=-1,this.mapTotalHeight=-1,void this.setLimits();this.mapTotalWidth=this.mapWidth*this.relativeGridSize,this.mapTotalHeight=this.mapHeight*this.relativeGridSize,this.setLimits(),this.drawQueue=[],this.aboveFoldDrawQueue=[],this.staticCallMade&&this.initStaticMap(),this.changed=!0}setLimits(){this.mapWidth>0&&this.mapHeight>0?this.isometricMode?(this.limits.xMin=-this.mapTotalWidth/2-this.relativeGridSize,this.limits.xLimit=this.mapTotalWidth/2-this.winWidth+2*this.relativeGridSize,this.limits.yMin=-this.relativeGridSize,this.limits.yLimit=this.mapTotalHeight/2-this.winHeight+2*this.relativeGridSize):(this.limits.xMin=0-this.winWidth/2,this.limits.xLimit=this.mapTotalWidth-this.winWidth/2,this.limits.yMin=0-this.winHeight/2,this.limits.yLimit=this.mapTotalHeight-this.winHeight/2,this.fitGridToHeight&&(this.limits.yMin=0,this.limits.yLimit=0)):(this.limits.xMin=-99999999,this.limits.xLimit=99999999,this.limits.yMin=-99999999,this.limits.yLimit=99999999)}setRelativeGridSize(){this.relativeGridSize=Math.round(this.gridSize*this.zoomLevel),this.relativeGridSize%2!=0&&this.relativeGridSize++,this.halfGridSize=this.gridSize/2,this.halfRelativeGridSize=this.relativeGridSize/2,this.quarterRelativeGridSize=this.relativeGridSize/4,this.twentiethGridSize=this.relativeGridSize/20}setViewBounds(){const e=this.positionToCoords(0-this.viewPadding,0-this.viewPadding),t=this.positionToCoords(this.winWidth+this.viewPadding,this.winHeight+this.viewPadding);if(this.isometricMode){const i=this.positionToCoords(this.winWidth+this.viewPadding,0-this.viewPadding),o=this.positionToCoords(0-this.viewPadding,this.winHeight+this.viewPadding);this.viewBounds=new b(e.x,i.y,t.x,o.y,this)}else this.viewBounds=new b(e.x,e.y,t.x,t.y,this)}getViewBounds(){return null==this.viewBounds&&this.setViewBounds(),this.viewBounds}initStaticMap(){this.staticMap={},this.staticMapInit=!0}positionToCoords(e,t){return new T(e,t,this)}getPointer(e,t,i,o){if(this.pointers[e])return this.pointers[e];const n={x:t,y:i,lastX:t,lastY:i,origX:t,origY:i,primary:!1,type:o,rightClick:!1,down:!1};return 0===this.pointersDown&&(n.primary=!0,this.primaryPointer=n),this.pointers[e]=n,n}setSelectionPoints(e,t){e<this.selectionX?(this.selectionTopX=e,this.selectionWidth=this.selectionX-e):(this.selectionTopX=this.selectionX,this.selectionWidth=e-this.selectionX),t<this.selectionY?(this.selectionTopY=t,this.selectionHeight=this.selectionY-t):(this.selectionTopY=this.selectionY,this.selectionHeight=t-this.selectionY)}sendSelectionPointsToFunction(e){const t=this.selectionTopX+this.selectionWidth,i=this.selectionTopY+this.selectionHeight;e(this.getCoordAndActual(this.selectionTopX,this.selectionTopY),this.getCoordAndActual(t,this.selectionTopY),this.getCoordAndActual(this.selectionTopX,i),this.getCoordAndActual(t,i))}getCoordAndActual(e,t){const i={aX:e,aY:t,x:e,y:t},o=this.positionToCoords(e,t);return i.x=o.x,i.y=o.y,i}checkBounds(){this.viewX<this.limits.xMin&&(this.viewX=this.limits.xMin),this.viewX>this.limits.xLimit&&(this.viewX=this.limits.xLimit),this.viewY<this.limits.yMin&&(this.viewY=this.limits.yMin),this.viewY>this.limits.yLimit&&(this.viewY=this.limits.yLimit),this.setViewBounds()}notifyViewportChange(e=!1){this.viewportChangeFunction&&this.viewportChangeFunction(e)}doZoom(e,t){let i=this.zoomLevel;t?(t>.15&&(t=.15),t<-.15&&(t=-.15),e?i<this.maxZoom&&(i-=i*t):i>this.minZoom&&(i-=i*t)):e?i<this.maxZoom&&(i+=.15):i>this.minZoom&&(i-=.15),this.setZoomLevel(i)}setZoomLevel(e){const t=this.getCenterPosition();this.zoomLevel=e,this.zoomLevel>=.9&&this.zoomLevel<=1.1&&(this.zoomLevel=1),this.zoomLevel>this.maxZoom&&(this.zoomLevel=this.maxZoom),this.zoomLevel<this.minZoom&&(this.zoomLevel=this.minZoom),this.setRelativeGridSize(),this.instructionsRecieved=!0,this.changed=!0,this.forceSceneChange(),this.centerOnCoord(t.x,t.y),this.optimizeForZoomLevel(),this.notifyViewportChange(!0)}getCenterPosition(){return this.positionToCoords(this.winWidth/2,this.winHeight/2)}forceSceneChange(){this.setMapDimensions(this.mapWidth,this.mapHeight),this.initStaticMap(),this.setRelativeGridSize(),this.notifyViewportChange(!0),this.changed=!0}centerOnCoord(e,t,i=!1){i?(this.viewX=e-this.winWidth/2,this.viewY=t-this.winHeight/2):(this.lastHoverX=e,this.lastHoverY=t,this.isometricMode?(this.viewX=(e-t)*this.halfRelativeGridSize-this.winWidth/2,this.viewY=(e+t)*this.quarterRelativeGridSize-this.winHeight/2):(this.viewX=Math.floor(e*this.relativeGridSize+this.halfRelativeGridSize-this.winWidth/2),this.viewY=Math.floor(t*this.relativeGridSize+this.halfRelativeGridSize-this.winHeight/2))),this.fitGridToHeight&&(this.viewY=0),this.checkBounds(),this.changed=!0}getStaticItem(e,t,i){return this.staticMapInit?(this.staticMap[i]||(this.staticMap[i]={}),this.staticMap[i][e]||(this.staticMap[i][e]={}),this.staticMap[i][e][t]?this.staticMap[i][e][t]:null):null}setStaticItem(e,t,i,o){if(!this.staticMapInit)return null;this.staticMap[i]||(this.staticMap[i]={}),this.staticMap[i][e]||(this.staticMap[i][e]={}),this.staticMap[i][e][t]=o}setNextDownInSelection(e){this.nextDownSelection=e}drawStaticTile(e,t,i,o){!function(e,t,i,o,n){if(null==t)return;if(i<0||i>e.mapWidth)return;if(o<0||o>e.mapHeight)return;if(n||(n=0),n>e.staticMaxZIndex&&(e.staticMaxZIndex=n,e.initStaticMap(),e.changed=!0),e.fullMapRenderCallback)return void $(e,t,i,o,n,!1,1,0);e.staticCallMade=!0,e.staticMapInit||e.initStaticMap(),e.instructionsRecieved=!0;const s=e.getStaticItem(i,o,n);null==s?(e.setStaticItem(i,o,n,J(e,t,i,o)),e.changed=!0):s.img!=t&&(e.setStaticItem(i,o,n,J(e,t,i,o,s)),e.changed=!0)}(this,e,t,i,o)}drawTile(e,t,i,o,n,s,r){return $(this,e,t,i,o,n,s,r)}drawSprite(e,t,i,o=t,n=i,s=0,r=null,l="#ff0000",a=1,h=0,c=1,d=1,p=null,u=0,g=!1,f=null,v=0,m=1,S=20,w=null,x=0,y=0,z=0){return K(this,e,t,i,o,n,s,r,l,a,h,c,d,p,u,g,f,v,m,S,w,x,y,z)}drawSpriteWithOptions(e){const t=e.img||null,i=e.x||0,o=e.y||0;return K(this,t,i,o,e.tX||i,e.tY||o,e.step||0,e.meterPercent||null,e.meterColor||"#ff0000",e.alpha||1,e.zIndex||0,e.tileWidth||1,e.tileHeight||1,e.chevrons||null,e.angle||0,e.centerChevrons||!1,e.textLabel||null,e.yOffset||0,e.scale||1,e.textSize||20,e.textFont||null,e.textYOffset||0,e.meterYOffset||0,e.elevation||0)}checkVisibility(e,t){let i,o;this.isometricMode?(i=(e-t)*this.halfRelativeGridSize,o=(e+t)*this.quarterRelativeGridSize):(i=e*this.relativeGridSize,o=t*this.relativeGridSize);let n=this.viewPadding;this.zoomLevel<.5&&(n=Math.max(0,this.viewPadding-this.relativeGridSize));const s=this.relativeGridSize+n;return i>this.viewX-s&&i<this.winWidth+this.viewX+s&&o>this.viewY-s&&o<this.winHeight+this.viewY+s}lerpToCoord(e,t,i,o=.15,n=1){this.lerpX=e,this.lerpY=t,this.lerpCallback=i,this.lerpSpeed=o,this.lerpAccuracy=n}setViewPadding(e){this.viewPadding=e}setGridSize(e){const t=this.getCenterPosition();this.gridSize=e,this.setRelativeGridSize(),this.changed=!0,V(this),this.centerOnCoord(t.x,t.y)}setDoubleHeightTiles(e){this.doubleHeightTiles=e}setDrawFunction(e){this.drawFunction=e}setClickFunction(e){this.clickFunction=e}setPointerListener(e){this.pointerListener=e}setRightClickFunction(e){this.rightClickFunction=e}setViewportChangeFunction(e){this.viewportChangeFunction=e}setHoverFunction(e){this.hoverFunction=e}setHoldFunction(e){this.holdFunction=e}setReleaseFunction(e){this.releaseFunction=e}setPaintFunction(e){this.paintFunction=e}setSelectionFunction(e,t,i){this.selectionFunction=e,this.selectionProgressFunction=t,this.selectionColor=i}alertPainting(e=null,t=600){this.isPainting=!0,this.paintTimeoutFunction=e,this.paintTimer&&clearTimeout(this.paintTimer);const i=this;this.paintTimer=setTimeout(function(){i.clearOutPaint()},t)}clearOutPaint(e=!1){this.isPainting=!1,this.paintTimer&&clearTimeout(this.paintTimer),this.paintTimer=null,e||this.paintTimeoutFunction&&this.paintTimeoutFunction()}popText(e,t,i,o="#FF0000"){!function(e,t,i,o,n){let s,r;if(e.isometricMode){const o=(t-i)*e.halfRelativeGridSize,n=(t+i)*e.quarterRelativeGridSize;s=o-e.halfRelativeGridSize+e.halfRelativeGridSize,r=n+e.halfRelativeGridSize-e.relativeGridSize+e.halfRelativeGridSize}else s=t*e.relativeGridSize+e.halfRelativeGridSize,r=i*e.relativeGridSize+e.halfRelativeGridSize;let l=null;0==G.length?l=new k(s,r,o,n):(l=G.pop(),l.x=s,l.y=r,l.text=o,l.color=n,l.cashed=!1,l.alpha=1),e.textPoppers.push(l)}(this,e,t,i,o)}drawSquare(e,t,i,o=0,n=null){!function(e,t,i,o,n,s){if(!e.drawQueue)return;if(!e.checkVisibility(i,o)&&!e.fullMapRenderCallback)return;e.instructionsRecieved=!0;let r=o;const l=_(e);if(l.isSquare=!0,l.color=t,l.img=s,e.isometricMode){r+=i;const t=(i-o)*e.halfRelativeGridSize,n=(i+o)*e.quarterRelativeGridSize;l.x=t,l.y=n}else l.x=i*e.relativeGridSize,l.y=o*e.relativeGridSize;l.nearness=r,l.zIndex=n,e.drawQueue.push(l)}(this,e,t,i,o,n)}drawText(e,t,i,o="#ffffff",n="#000000",s=20,r=null,l=1){!function(e,t,i,o,n,s,r,l,a){const h=_(e);e.isometricMode?(h.x=(i-o)*e.halfRelativeGridSize,h.y=(i+o)*e.quarterRelativeGridSize):(h.x=i*e.relativeGridSize+e.halfRelativeGridSize,h.y=o*e.relativeGridSize+e.halfRelativeGridSize),h.isText=t,h.lineWidth=r,h.textFont=l,h.zIndex=a,h.color=n,h.barColor=s,e.drawQueue.push(h)}(this,e,t,i,o,n,s,r,l)}setSnowing(e){this.particleEngine&&(this.particleEngine.snowRunning=e)}setEmbers(e){this.particleEngine&&(this.particleEngine.embersRunning=e)}setRaining(e){this.particleEngine&&(this.particleEngine.rainRunning=e)}renderFullMap(e){this.setZoomLevel(1),this.fullMapRenderCallback=e}setIsometric(e){this.isometricMode=e,this.changed=!0}getFPS(){return Y}setUpdateFunction(e,t=60){this.updateFunction=e,this.updateTime=1e3/t}update(e,t){!function(e,t,i){if(e.lightSources=[],(e.mouseScrolling.up||e.mouseScrolling.down||e.mouseScrolling.left||e.mouseScrolling.right)&&(e.changed=!0,e.mouseScrolling.up&&(e.viewY-=40*i),e.mouseScrolling.down&&(e.viewY+=40*i),e.mouseScrolling.left&&(e.viewX-=40*i),e.mouseScrolling.right&&(e.viewX+=40*i),e.checkBounds(),e.notifyViewportChange(!0)),e.gamepadNegotiationTimer+=i,e.gamepadNegotiationTimer>=4&&(e.gamepadNegotiationTimer=0,function(e){let t=!1;!e.padScrolling.up||e.padScrolling.down||e.padScrolling.left||e.padScrolling.right||(e.lastHoverY--,e.isometricMode&&e.lastHoverX--,t=!0),!e.padScrolling.down||e.padScrolling.up||e.padScrolling.left||e.padScrolling.right||(e.lastHoverY++,e.isometricMode&&e.lastHoverX++,t=!0),!e.padScrolling.left||e.padScrolling.right||e.padScrolling.up||e.padScrolling.down||(e.lastHoverX--,e.isometricMode&&e.lastHoverY++,t=!0),!e.padScrolling.right||e.padScrolling.left||e.padScrolling.up||e.padScrolling.down||(e.lastHoverX++,e.isometricMode&&e.lastHoverY--,t=!0),e.padScrolling.up&&!e.padScrolling.down&&!e.padScrolling.left&&e.padScrolling.right&&(e.lastHoverY--,e.isometricMode&&e.lastHoverX++,t=!0),e.padScrolling.down&&!e.padScrolling.up&&!e.padScrolling.left&&e.padScrolling.right&&(e.lastHoverY++,e.isometricMode&&e.lastHoverX--,t=!0),e.padScrolling.left&&!e.padScrolling.right&&!e.padScrolling.up&&e.padScrolling.down&&(e.lastHoverX--,e.isometricMode&&e.lastHoverY--,t=!0),e.padScrolling.right&&!e.padScrolling.left&&!e.padScrolling.up&&e.padScrolling.down&&(e.lastHoverX++,e.isometricMode&&e.lastHoverY++,t=!0),t&&e.hoverFunction&&(e.hoverFunction(e.lastHoverX,e.lastHoverY,0,0,"gamepad",e.lastHoverX,e.lastHoverY),e.centerOnCoord(e.lastHoverX,e.lastHoverY));let i=!1;e.padRightScrolling.left&&(e.viewX-=40,i=!0),e.padRightScrolling.right&&(e.viewX+=40,i=!0),e.padRightScrolling.up&&(e.viewY-=40,i=!0),e.padRightScrolling.down&&(e.viewY+=40,i=!0),i&&(e.changed(),e.notifyViewportChange(!0),e.checkBounds()),e.padTriggers.right&&!e.padTriggers.left&&e.doZoom(!0),e.padTriggers.left&&!e.padTriggers.right&&e.doZoom(!1)}(e)),!e.updateFunction)return;let o=0;o=isNaN(e.lastUpdateUpdate)?1e3:t-e.lastUpdateUpdate;const n=o/e.updateTime;o>=e.updateTime&&(e.lastUpdateUpdate=t,e.updateFunction(t,n))}(this,e,t)}setFitGridToHeight(e){this.fitGridToHeight=e,V(this)}setColorFilter(e=null,t=.1){this.darknessMaskColor=null,this.colorFilter=e,this.filterAmount=t,this.changed=!0}initParticleEngine(){this.particleEngine=v()}playParticleEffect(e,t,i){if(!this.particleEngine)return;let o,n;this.isometricMode?(o=(t-i)*this.halfRelativeGridSize,n=(t+i)*this.quarterRelativeGridSize):(o=t*this.relativeGridSize,n=i*this.relativeGridSize);const s=o-this.viewX,r=n-this.viewY;this.particleEngine.playEffect(e,s,r)}drawLine(e,t,i,o,n,s=0,r=!1,l=1,a=!1){!function(e,t,i,o,n,s,r,l,a,h){if(!e.drawQueue)return;e.instructionsRecieved=!0;const c=2*i+2*o+r,d=_(e);if(d.isLine=!0,d.color=t,d.alpha=1,d.lineWidth=a,d.zIndex=r,d.dashedLine=h,e.isometricMode){const t=(i-o)*e.halfRelativeGridSize,r=(i+o)*e.quarterRelativeGridSize,a=(n-s)*e.halfRelativeGridSize,h=(n+s)*e.quarterRelativeGridSize;d.x=t,d.y=r,d.w=a,d.h=h,l&&(d.y+=e.quarterRelativeGridSize,d.h+=e.quarterRelativeGridSize)}else d.x=i*e.relativeGridSize,d.y=o*e.relativeGridSize,d.w=n*e.relativeGridSize,d.h=s*e.relativeGridSize,l&&(d.x+=e.halfRelativeGridSize,d.y+=e.halfRelativeGridSize,d.w+=e.halfRelativeGridSize,d.h+=e.halfRelativeGridSize);d.nearness=c,e.drawQueue.push(d)}(this,e,t,i,o,n,s,r,l,a)}drawCircle(e,t,i,o,n=0,s=1,r=!1){!function(e,t,i,o,n,s,r,l){const a=_(e);a.isCircle=!0,a.color=t,a.alpha=1,a.lineWidth=r,a.zIndex=s,a.dashedLine=l,a.h=n*e.relativeGridSize/2;let h=o;e.isometricMode?(h+=i,a.x=(i-o)*e.halfRelativeGridSize,a.y=(i+o)*e.quarterRelativeGridSize,a.y+=e.quarterRelativeGridSize):(a.x=i*e.relativeGridSize,a.y=o*e.relativeGridSize,a.x+=e.halfRelativeGridSize,a.y+=e.halfRelativeGridSize),a.nearness=h+.56,e.drawQueue.push(a)}(this,e,t,i,o,n,s,r)}setBorderColor(e){e?(this.style.border="4px solid "+e,this.filterOverlay.style.top="0px",this.filterOverlay.style.left="0px",this.filterOverlay.style.width="calc(100% - 8px)",this.filterOverlay.style.height="calc(100% - 8px)"):(this.filterOverlay.style.border="none",this.normalizeFilterOverlaySize())}normalizeFilterOverlaySize(){this.filterOverlay.style.top="0px",this.filterOverlay.style.left="0px",this.filterOverlay.style.width="100%",this.filterOverlay.style.height="100%"}outlineTileGroup(e,t,i,o,n,s=0){const r=function(e){let t,i,o,n,s,r,l,a;const h=[];for(t=0;t<e.length;t++){for(o=e[t],s=!0,r=!0,l=!0,a=!0,i=0;i<e.length;i++)n=e[i],o!=n&&(o.x==n.x&&(n.y==o.y-1&&(s=!1),n.y==o.y+1&&(l=!1)),o.y==n.y&&(n.x==o.x-1&&(a=!1),n.x==o.x+1&&(r=!1)));s&&h.push({x1:o.x,y1:o.y,x2:o.x+1,y2:o.y}),r&&h.push({x1:o.x+1,y1:o.y,x2:o.x+1,y2:o.y+1}),l&&h.push({x1:o.x,y1:o.y+1,x2:o.x+1,y2:o.y+1}),a&&h.push({x1:o.x,y1:o.y,x2:o.x,y2:o.y+1})}return h}(e);for(const e of r)this.drawLine(i,e.x1-s,e.y1-s,e.x2+s,e.y2+s,t,!1,o,n)}setFastRenderMode(e){this.useFastRenderMode=e}optimizeForZoomLevel(){this.zoomLevel<.3?(this.setFPSLimiter(3),this.setFastRenderMode(!0)):this.zoomLevel<.6?(this.setFPSLimiter(2),this.setFastRenderMode(!0)):(this.setFPSLimiter(1),this.setFastRenderMode(!1))}getZoomLevel(){return this.zoomLevel}setMaxZoomLevel(e){this.maxZoom=e}setMinZoomLevel(e){this.minZoom=e}startPan(e){this.mouseScrolling[e]=!0}endPan(e){this.mouseScrolling[e]=!1}takeScreenshot(e){this.screenshotCanvas=document.createElement("canvas"),this.screenshotContext=this.screenshotCanvas.getContext("2d"),this.pixelated&&oe(this.screenshotCanvas),this.screenshotCanvas.width=this.width,this.screenshotCanvas.height=this.height,this.screenshotCallback=e,this.screenshotPhase=!0}setFPSLimiter(e){this.fpsLimiter=e}modifyViewX(e){this.viewX+=e,this.checkBounds(),this.changed=!0,this.notifyViewportChange()}modifyViewY(e){this.viewY+=e,this.checkBounds(),this.changed=!0,this.notifyViewportChange()}getUsingTouch(){return this.usingTouch}gamepadDown(e){!function(e,t){"lt"==t&&(e.padTriggers.left=!0),"rt"==t&&(e.padTriggers.right=!0),"up"==t&&(e.padScrolling.up=!0,e.padScrolling.down=!1),"down"==t&&(e.padScrolling.down=!0,e.padScrolling.up=!1),"left"==t&&(e.padScrolling.left=!0,e.padScrolling.right=!1),"right"==t&&(e.padScrolling.right=!0,e.padScrolling.left=!1),"rup"==t&&(e.padRightScrolling.up=!0),"rdown"==t&&(e.padRightScrolling.down=!0),"rleft"==t&&(e.padRightScrolling.left=!0),"rright"==t&&(e.padRightScrolling.right=!0),"a"==t&&(e.aDownTime=(new Date).getTime())}(this,e)}gamepadUp(e){!function(e,t){"lt"==t&&(e.padTriggers.left=!1),"rt"==t&&(e.padTriggers.right=!1),"up"==t&&(e.padScrolling.up=!1),"down"==t&&(e.padScrolling.down=!1),"left"==t&&(e.padScrolling.left=!1),"right"==t&&(e.padScrolling.right=!1),"rup"==t&&(e.padRightScrolling.up=!1),"rdown"==t&&(e.padRightScrolling.down=!1),"rleft"==t&&(e.padRightScrolling.left=!1),"rright"==t&&(e.padRightScrolling.right=!1),"a"==t&&((new Date).getTime()-e.aDownTime<400&&e.clickFunction&&e.clickFunction(e.lastHoverX,e.lastHoverY,0,0,"gamepad",e.lastHoverX,e.lastHoverY),e.aDownTime=0)}(this,e)}drawLight(e,t,o=this.relativeGridSize,n="#ffffff",s=e,r=t,l=0,a=.2){!function(e,t,o,n,s,r,l,a,h){if(!e.checkVisibility(t,o)&&!e.fullMapRenderCallback)return;const c=i(s),d=n*e.relativeGridSize;let p=t,u=o;if(e.isometricMode?(p=(t-o)*e.halfRelativeGridSize,u=(t+o)*e.quarterRelativeGridSize):(p=t*e.relativeGridSize,u=o*e.relativeGridSize+e.relativeGridSize-e.halfRelativeGridSize),t!=r||o!=l){const i=e.twentiethGridSize*a;e.isometricMode?(r>t&&(p+=i/2,u+=i/4),r<t&&(p-=i/2,u-=i/4),l>o&&(p-=i/2,u+=i/4),l<o&&(p+=i/2,u-=i/4)):(r>t&&(p+=i),r<t&&(p-=i),l>o&&(u+=i),l<o&&(u-=i))}e.lightSources.push(function(e,t,i,o,n){if(X.length>0){const s=X.pop();return s.x=e,s.y=t,s.radius=i,s.color=o,s.intensity=n,s}return new H(e,t,i,o,n)}(p,u,d,c,h))}(this,e,t,o,n,s,r,l,a)}gamepadAllStop(){for(const e in this.padScrolling)this.padScrolling[e]=!1;for(const e in this.padRightScrolling)this.padRightScrolling[e]=!1;for(const e in this.padTriggers)this.padTriggers[e]=!1;this.aDownTime=0}getCanvasStream(e=25){return this.canvas.captureStream(e)}getDrawCanvas(){return this.canvas}}class T{constructor(e,t,i){this.x=e,this.y=t,this.px=e,this.py=t,i&&(i.isometricMode?(this.px=((e+i.viewX)/i.halfRelativeGridSize+(t+i.viewY)/i.quarterRelativeGridSize)/2,this.py=((t+i.viewY)/i.quarterRelativeGridSize-(e+i.viewX)/i.halfRelativeGridSize)/2):(this.px=(e+i.viewX)/i.relativeGridSize,this.py=(t+i.viewY)/i.relativeGridSize)),this.x=Math.floor(this.px),this.y=Math.floor(this.py)}}class b{constructor(e,t,i,o,n){this.minX=e,this.minY=t,this.maxX=i,this.maxY=o,n&&n.mapWidth>0&&n.mapHeight>0&&(this.minX<0&&(this.minX=0),this.minY<0&&(this.minY=0),this.maxX>n.mapWidth&&(this.maxX=n.mapWidth),this.maxY>n.mapHeight&&(this.maxY=n.mapHeight))}}class L{constructor(){this.x=0,this.y=0,this.img=null,this.w=0,this.h=0,this.alpha=null,this.isBar=!1,this.barWidth=0,this.meterWidth=0,this.barColor="#000000",this.isSquare=!1,this.isLine=!1,this.isCircle=!1,this.color="#000000",this.nearness=0,this.tileWidth=1,this.tileHeight=1,this.zIndex=0,this.altitude=0,this.segmentX=-1,this.cX=0,this.cY=0,this.destSegX=0,this.sW=0,this.sH=0,this.blocksLight=!1,this.ro=0,this.lineWidth=1,this.angle=0,this.tX=0,this.tY=0,this.dashedLine=!1,this.isText=null,this.textFont=null}}class P{constructor(e=null,t=null){this.color=e,this.image=t}}class k{constructor(e,t,i,o){this.x=e,this.y=t,this.text=i,this.color=o,this.alpha=1,this.cashed=!1}}class H{constructor(e,t,i,o,n){this.x=e,this.y=t,this.radius=i,this.color=o,this.intensity=n}}function D(){for(const e in z)z[e].resize()}function A(e){return i(e)}function V(e){e.canvas&&(e.changed=!0,e.winWidth=e.holder.offsetWidth,e.winHeight=e.holder.offsetHeight,e.width=Math.round(e.winWidth*e.scale),e.height=Math.round(e.winHeight*e.scale),e.canvas.width=e.width,e.canvas.height=e.height,e.staticCanvas.width=e.width,e.staticCanvas.height=e.height,e.lightCanvas.width=e.width,e.lightCanvas.height=e.height,e.lightFinalRenderCanvas.width=e.width,e.lightFinalRenderCanvas.height=e.height,e.fitGridToHeight&&e.mapHeight>0&&(e.gridSize=e.winHeight/e.mapHeight),e.context.setTransform(1,0,0,1,0,0),e.context.scale(e.scale,e.scale),e.staticContext.setTransform(1,0,0,1,0,0),e.staticContext.scale(e.scale,e.scale),e.setRelativeGridSize(),e.mapTotalWidth=e.mapWidth*e.relativeGridSize,e.mapTotalHeight=e.mapHeight*e.relativeGridSize,e.setLimits(),e.setViewBounds(),e.changed=!0)}function W(e){e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.overflow="hidden"}function I(e){e.isSelection=!0,e.selectionX=e.holdX,e.selectionY=e.holdY,e.setSelectionPoints(e.holdX,e.holdY),e.selectionProgressFunction&&e.sendSelectionPointsToFunction(e.selectionProgressFunction)}function B(e,t){const i=t.zIndex-e.zIndex;if(0!==i)return i;const o=t.nearness-e.nearness;if(0!==o)return o;const n=t.cX-e.cX;if(0!==n)return n;const s=t.cY-e.cY;return 0!==s?s:t.ro-e.ro}function O(e,t,i,o){let n,s;if(e.isometricMode?(n=t.x-e.viewX,s=t.y-e.viewY):(n=t.x-e.viewX+.5|0,s=t.y-e.viewY+.5|0),!o||t.isLine||t.isCircle||!(n+t.w<0||s+t.h<0||n>e.width||s>e.height)){if(t.isLine&&!function(e,t,i,o,n,s,r,l){const a=0+r,h=0+l;return!(e<0&&i<0||e>a&&i>a||t<0&&o<0||t>h&&o>h)&&(e>=0&&e<=a&&t>=0&&t<=h||i>=0&&i<=a&&o>=0&&o<=h||(!!j(e,t,i,o,0,0,a,0).onLine1||(!!j(e,t,i,o,0,h,a,h).onLine1||(!!j(e,t,i,o,0,0,0,h).onLine1||!!j(e,t,i,o,a,0,a,h).onLine1))))}(n,s,t.w-e.viewX+.5|0,t.h-e.viewY+.5|0,0,0,e.winWidth,e.winHeight))return;if(t.blocksLight&&!e.isometricMode){let t=s;e.doubleHeightTiles&&(t+=e.relativeGridSize),e.lightBlockers.push({x:n,y:t})}t.isText?function(e,t,i,o,n){const s=i.lineWidth*e.zoomLevel;t.setLineDash([]),t.textBaseline="middle";let r=t.font="bold "+s+"px sans-serif";var l,a,h,c,d,p,u,g,f;i.textFont&&(r="bold "+s+"px "+i.textFont),l=t,a=r,h=i.color,c=i.barColor,d=i.isText,p=o,u=n,g=2,f=e.zoomLevel,c||(c="#000000"),a||(a="bold "+Math.round(12*f)+"px sans-serif"),h||(h="#ffffff"),g||(g=1),l.textAlign="center",l.font=a,l.strokeStyle=c,l.lineWidth=g,l.lineJoin="miter",l.miterLimit=2,l.strokeText(d,p,u),l.fillStyle=h,l.fillText(d,p,u)}(e,i,t,n,s):t.isLine?function(e,t,i,o,n){const s=i.w-e.viewX+.5|0,r=i.h-e.viewY+.5|0;t.lineWidth=i.lineWidth,t.strokeStyle=i.color,t.globalAlpha=i.alpha,i.dashedLine?t.setLineDash([4,10]):t.setLineDash([]),t.beginPath(),t.moveTo(o,n),t.lineTo(s,r),t.stroke()}(e,i,t,n,s):t.isCircle?function(e,t,i,o,n){i.lineWidth>0?(t.lineWidth=i.lineWidth,t.strokeStyle=i.color,i.dashedLine?t.setLineDash([4,10]):t.setLineDash([])):t.fillStyle=i.color,t.globalAlpha=i.alpha,t.beginPath(),e.isometricMode?t.ellipse(o,n,i.h,i.h/2,0,0,S):t.ellipse(o,n,i.h,i.h,0,0,S),i.lineWidth>0?t.stroke():t.fill()}(e,i,t,n,s):t.isSquare?function(e,t,i,o,n){t.fillStyle=i.color,t.globalAlpha=1,i.img&&(t.save(),t.globalCompositeOperation=i.img),e.isometricMode?(t.beginPath(),t.moveTo(o,n),t.lineTo(o+e.halfRelativeGridSize,n+e.quarterRelativeGridSize),t.lineTo(o,n+e.halfRelativeGridSize),t.lineTo(o-e.halfRelativeGridSize,n+e.quarterRelativeGridSize),t.fill()):t.fillRect(o,n,e.relativeGridSize+1,e.relativeGridSize+1),i.img&&t.restore()}(e,i,t,n,s):t.isBar?function(e,t,i,o,n){const s=i.barWidth;let r=i.meterWidth;r<0&&(r=0),t.globalAlpha=1,t.fillStyle="#000000",t.fillRect(o,n,s,6),t.fillStyle=i.barColor,t.fillRect(o+1,n+1,r,4)}(0,i,t,n,s):(null!=t.alpha&&null!=t.alpha?i.globalAlpha=t.alpha:i.globalAlpha=1,t.segmentX>0?function(e,t,i,o,n){n+i.h<0||o+i.destSegX+e.halfRelativeGridSize<0||t.drawImage(i.img,i.segmentX,0,i.sW,i.sH,o+i.destSegX,n,e.halfRelativeGridSize+1,i.h)}(e,i,t,n,s):function(e,t,i,o,n,s){0!=i.angle&&(t.save(),t.translate(o+e.halfRelativeGridSize,n+e.halfRelativeGridSize),t.rotate(i.angle*w),o=-e.halfRelativeGridSize,n=-e.halfRelativeGridSize),i.img&&t.drawImage(i.img,o,n,i.w,i.h),0!=i.angle&&t.restore(),s&&q(e,s,i.img,i.tX,i.tY)}(e,i,t,n,s,o))}else t.isBar||t.isLine||t.isSquare||q(e,o,t.img,t.tX,t.tY)}function E(e,t,i){if(i.alpha<=.05)return void(i.cashed=!0);const o=i.x-e.viewX,n=i.y-e.viewY,s=Math.max(12,20*e.zoomLevel);t.setLineDash([]),t.strokeStyle="#000000",t.lineWidth=1,t.fillStyle=i.color,t.textAlign="center",t.textBaseline="middle",t.font="bold "+s+"px sans-serif",t.save(),t.globalAlpha=i.alpha,t.fillText(i.text,o,n),t.strokeText(i.text,o,n),t.restore()}function q(e,t,i,o,n){if(!t)return;let s=Math.floor(o*e.gridSize)/2,r=(n-1)*e.gridSize/2-i.height/2;e.isometricMode&&(s=Math.floor((o-n)*e.halfRelativeGridSize)/2,r=(o+n)*e.quarterRelativeGridSize/2,s+=t.canvas.width/2),t.drawImage(i,s,r,i.width/2,i.height/2)}function Z(e,t,i,o,n,s,r){if(!n||isNaN(n)||n<0)return;let l;if(e.isometricMode)return void(n>.8*e.relativeGridSize?(t.save(),t.transform(1,0,0,.5,0,0),l=t.createRadialGradient(i,2*o,0,i,2*o,n),l.addColorStop(0,s),l.addColorStop(1,r),t.fillStyle=l,t.beginPath(),t.arc(i,2*o,n,0,S),t.fill(),t.restore()):(l=t.createRadialGradient(i,o,0,i,o,n),l.addColorStop(0,s),l.addColorStop(1,r),t.fillStyle=l,t.beginPath(),t.arc(i,o,n,0,S),t.fill()));e.preRenderCanvas.height=2*n,e.preRenderCanvas.width=2*n,e.gradientFilterCanvas.height=2*n,e.gradientFilterCanvas.width=2*n;let a,h,c,d,p,u,g=[];if(!e.isometricMode)for(a=0;a<e.lightBlockers.length;a++)u=e.lightBlockers[a],h=i-u.x,c=o-u.y,d=Math.sqrt(h*h+c*c),d<=n+.05*n&&(u.d=d,g.push(u));if(u=null,e.isometricMode&&n>.8*e.relativeGridSize?(e.preRenderContext.save(),e.preRenderContext.transform(1,0,0,.5,0,0),l=t.createRadialGradient(n,2*n,0,n,2*n,n),l.addColorStop(0,s),l.addColorStop(1,r),e.preRenderContext.fillStyle=l,e.preRenderContext.beginPath(),e.preRenderContext.arc(n,2*n,n,0,S),e.preRenderContext.fill(),e.preRenderContext.restore()):(l=t.createRadialGradient(n,n,0,n,n,n),l.addColorStop(0,s),l.addColorStop(1,r),e.preRenderContext.fillStyle=l,e.preRenderContext.beginPath(),e.preRenderContext.arc(n,n,n,0,S),e.preRenderContext.fill()),e.isometricMode)return t.save(),t.globalCompositeOperation="lighten",t.drawImage(e.preRenderCanvas,i-n,o-n),void t.restore();let f=[],v=[];for(a=0;a<360;a++){const e=n+(n+.05*n)*Math.cos(a),t=n+(n+.05*n)*Math.sin(a);f.push({x:e,y:t})}for(;g.length>0;)N(e,g.pop(),n,v,i,o);let m=[];for(a=0,p=f.length;a<p;a++)U(f[a],n,v,m);for(e.gradientFilterContext.fillStyle="rgba(0,0,0,.3)",e.gradientFilterContext.fillRect(0,0,e.gradientFilterCanvas.width,e.gradientFilterCanvas.height),e.gradientFilterContext.fillStyle="#ff0000",a=0,p=m.length;a<p;a++)e.gradientFilterContext.fillRect(m[a].x,m[a].y,e.relativeGridSize,e.relativeGridSize);for(f.sort(Q),e.gradientFilterContext.beginPath(),e.gradientFilterContext.moveTo(f[0].x,f[0].y),a=1,p=f.length;a<p;a++)e.gradientFilterContext.lineTo(f[a].x,f[a].y);e.gradientFilterContext.closePath(),e.gradientFilterContext.fill(),e.preRenderContext.save(),e.preRenderContext.globalCompositeOperation="destination-in",e.preRenderContext.drawImage(e.gradientFilterCanvas,0,0),e.preRenderContext.restore(),t.save(),t.globalCompositeOperation="lighten",t.drawImage(e.preRenderCanvas,i-n,o-n),t.restore()}function Q(e,t){return e.angle>t.angle?1:e.angle<t.angle?-1:void 0}function N(e,t,i,o,n,s){const r=Math.atan2(t.y-s,t.x-n),l=i+t.d*Math.cos(r),a=i+t.d*Math.sin(r),h={x:l,y:a},c={x:l+e.relativeGridSize,y:a},d={x:l,y:a+e.relativeGridSize},p={x:l+e.relativeGridSize,y:a+e.relativeGridSize};o.push({x1:h.x,y1:h.y,x2:c.x,y2:c.y,source:h}),o.push({x1:c.x,y1:c.y,x2:p.x,y2:p.y,source:h}),o.push({x1:d.x,y1:d.y,x2:p.x,y2:p.y,source:h}),o.push({x1:h.x,y1:h.y,x2:d.x,y2:d.y,source:h})}function U(e,t,i,o){let n,s,r,l=99999999,a=null;for(let o=0,h=i.length;o<h;o++){const h=i[o],c=j(t,t,e.x,e.y,h.x1,h.y1,h.x2,h.y2);c.onLine1&&c.onLine2&&(n=t-c.x,s=t-c.y,r=Math.sqrt(n*n+s*s),r<l&&(e.x=c.x,e.y=c.y,l=r,h.source&&(a=h.source)))}null!=a&&o.push(a)}function j(e,t,i,o,n,s,r,l){let a,h,c,d,p,u={x:null,y:null,onLine1:!1,onLine2:!1};return a=(l-s)*(i-e)-(r-n)*(o-t),0==a||(h=t-s,c=e-n,d=(r-n)*h-(l-s)*c,p=(i-e)*h-(o-t)*c,h=d/a,c=p/a,u.x=e+h*(i-e),u.y=t+h*(o-t),h>0&&h<1&&(u.onLine1=!0),c>0&&c<1&&(u.onLine2=!0)),u}function $(e,t,i,o,n=0,s=!1,r=1,l=0){if(!e.drawQueue||null==t||null==t)return;if(e.instructionsRecieved=!0,!e.checkVisibility(i,o)&&!e.fullMapRenderCallback)return;if(e.zoomLevel<.25&&!e.fullMapRenderCallback){if(i%4!=0||o%4!=0)return}else if(e.zoomLevel<.5&&!e.fullMapRenderCallback&&(i%2!=0||o%2!=0))return;const a=J(e,t,i,o,null);a.tX=i,a.tY=o,a.nearness=o,a.alpha=r,a.blocksLight=s,a.zIndex=n,a.angle=l,e.isometricMode&&(a.nearness+=i),e.drawQueue.push(a)}function J(e,t,i,o,n){null!=n&&null!=n||(n=_(e)),n.img=t;let s=e.relativeGridSize,r=e.relativeGridSize;if(e.isometricMode){if(r=e.halfRelativeGridSize,t.width!=2*t.height){const i=t.width/e.relativeGridSize;r=t.height/i}const l=(i-o)*e.halfRelativeGridSize,a=(i+o)*e.quarterRelativeGridSize,h=l-e.halfRelativeGridSize,c=a+e.halfRelativeGridSize-r;n.x=h,n.y=c,n.w=s,n.h=r,n.nearness=i+o}else{if(t.width!=t.height){const i=t.height/t.width;r=e.relativeGridSize*i}s=Math.ceil(s),r=Math.ceil(r);const l=i*e.relativeGridSize,a=o*e.relativeGridSize+e.relativeGridSize-r;n.x=l,n.y=a,n.w=s,n.h=r}return n}function _(e){let t;return 0==C.length?t=new L:(t=C.pop(),t.x=0,t.y=0,t.img=null,t.w=0,t.h=0,t.alpha=null,t.isBar=!1,t.barWidth=0,t.meterWidth=0,t.barColor="#000000",t.isSquare=!1,t.isLine=!1,t.isCircle=!1,t.color="#000000",t.nearness=0,t.tileWidth=1,t.tileHeight=1,t.zIndex=0,t.altitude=0,t.segmentX=-1,t.cX=0,t.cY=0,t.destSegX=0,t.sW=0,t.sH=0,t.blocksLight=!1,t.lineWidth=1,t.angle=0,t.tX=0,t.tY=0,t.dashedLine=!1,t.isText=null,t.textFont=null),t.ro=e.renderOrder,e.renderOrder++,t}function K(e,t,i,o,n,s,r,l,a,h,c,d,p,u,g,f,v,m,S,w,x,y,z,C){if(!t)return;if(e.fullMapRenderCallback)return void $(e,t,i,o,c,!1,h,g);if(!e.checkVisibility(i,o))return;if(e.instructionsRecieved=!0,C=parseFloat(C),isNaN(C)&&(C=0),e.isometricMode&&n==i&&s==o&&!e.useFastRenderMode)return function(e,t,i,o,n,s,r,l,a,h,c,d,p,u,g,f,v,m,S,w,x,y,z,C){let G,X,R=t.width*S,Y=t.height*S;1!=e.zoomLevel&&(R*=e.zoomLevel,Y*=e.zoomLevel);const M=i+d-1,F=o+p-1,T=(M-(o-m))*e.halfRelativeGridSize,b=(M+(F-m))*e.quarterRelativeGridSize+e.halfRelativeGridSize,L=T+e.halfRelativeGridSize;G=L-R,X=b-Y;const P=e.halfGridSize/S,k=Math.round(t.width/P);let H=0,D=0;for(let n=0;n<k;n++){const s=_(e),r=G+e.halfRelativeGridSize*n,g=r+e.halfRelativeGridSize;let v=i+o;for(let t=i;t<i+d;t++)for(let i=o;i<o+p;i++){const o=(t-i)*e.halfRelativeGridSize,n=o-e.halfRelativeGridSize;let s=o+e.halfRelativeGridSize;s>L&&(s=L);const l=t+i;s>=r&&n<=g&&l>v&&(v=l)}s.sW=P,s.sH=t.height,s.img=t,s.zIndex=c,C&&(0==n&&(ie(e,i,o,c,d),X-=Math.round((C&e.gridSize)*e.zoomLevel)),v+=C),s.cX=i,s.cY=o,s.x=G,s.y=X,s.w=R,s.h=Y,s.tileWidth=d,s.tileHeight=p,s.alpha=h,s.nearness=v,s.segmentX=H,s.destSegX=D,H+=P,D+=e.halfRelativeGridSize,e.drawQueue.push(s),n==d-1&&ee(e,o,G,X,R,Y,l,a,u,f,m,z,v,c)}return v&&te(e,v,x,w,G,X,R,Y,i+o,c,y),{x:G,y:X,w:R,h:Y}}(e,t,i,o,0,0,0,l,a,h,c,d,p,u,0,f,v,m,S,w,x,y,z,C);const G=_(e);let X,R;G.tX=i,G.tY=o,G.blocksLight=!1,G.angle=g,G.img=t,G.zIndex=c,G.tileHeight=p,G.tileWidth=d,G.alpha=h;let Y=t.width*S,M=t.height*S;1!=e.zoomLevel&&(Y*=e.zoomLevel,M*=e.zoomLevel);let F=o;if(e.isometricMode){const t=i+d-1,n=o+p-1,s=(t-(o-m))*e.halfRelativeGridSize,r=(t+(n-m))*e.quarterRelativeGridSize+e.halfRelativeGridSize;X=s+e.halfRelativeGridSize-Y,R=r-M,F=t+n}else X=i*e.relativeGridSize,R=(o-m)*e.relativeGridSize+e.relativeGridSize-M;if(i!=n||o!=s){const t=e.twentiethGridSize*r;if(e.isometricMode){let e=i,r=o;n>i&&(X+=t/2,R+=t/4,e+=2),n<i&&(X-=t/2,R-=t/4,e++),s>o&&(X-=t/2,R+=t/4,r+=2),s<o&&(X+=t/2,R-=t/4,r++),F=e+r}else n>i&&(X+=t),n<i&&(X-=t),s>o&&(R+=t),s<o&&(R-=t)}return C>0&&(ie(e,i,o,c,d),F+=C,R-=Math.round((C&e.gridSize)*e.zoomLevel)),G.x=X,G.y=R,G.w=Y,G.h=M,G.nearness=F,e.drawQueue.push(G),ee(e,o,X,R,Y,M,l,a,u,f,m,z,F,c),v&&te(e,v,x,w,X,R,Y,M,F,c,y),{x:X,y:R,w:Y,h:M}}function ee(e,t,i,o,n,s,r,l,a,h,c,d,p,u){let g=!1;if(r&&r>0){g=!0;const a=_(e);a.isBar=!0,a.x=i,a.y=o+s,d&&(a.y=(t-c+d)*e.relativeGridSize+e.relativeGridSize);let h=n;e.isometricMode||(h=Math.round(.7*n),a.x+=Math.round(.15*n)),a.barWidth=h,a.meterWidth=h*r-2,a.barColor=l,a.nearness=p+1,e.isometricMode&&a.nearness++,a.zIndex=u+1,e.aboveFoldDrawQueue.push(a)}if(null!=a){let t=i,r=o+s;if(g&&(r+=10),h){r=o+Math.round(s/2),r-=5;let e=0;for(const t of a)t.image?e+=20:e+=10;const l=Math.round(e/2);t=i+Math.round(n/2)-l}for(const i of a){const o=_(e);o.x=t,o.y=r,i.image?(o.img=i.image,o.w=16,o.h=16,o.y-=5,t+=10):(o.isBar=!0,o.barWidth=6,o.meterWidth=4,o.barColor=i.color),o.nearness=p+1,e.isometricMode&&o.nearness++,o.zIndex=u+1,e.aboveFoldDrawQueue.push(o),t+=10}}}function te(e,t,i,o,n,s,r,l,a,h,c){const d=_(e);d.isText=t,d.textFont=i,d.lineWidth=o,d.x=n+Math.round(r/2),d.y=s+Math.round(l/2),d.color="#ffffff",d.barColor="#000000",c&&(d.y+=c*e.relativeGridSize),d.nearness=a+1,e.isometricMode&&d.nearness++,d.zIndex=h+1,e.drawQueue.push(d)}function ie(e,t,i,o,n){const s=_(e);let r=i;e.isometricMode?(r+=t,s.x=(t-i)*e.halfRelativeGridSize,s.y=(t+i)*e.quarterRelativeGridSize,s.y+=e.quarterRelativeGridSize):(s.x=t*e.relativeGridSize,s.y=i*e.relativeGridSize,s.x+=e.halfRelativeGridSize,s.y+=e.halfRelativeGridSize),s.isCircle=!0,s.color="rgba(0,0,0,0.25)",s.alpha=1,s.lineWidth=0,s.zIndex=o,s.h=n*e.relativeGridSize/4,s.nearness=r+.1,e.drawQueue.push(s)}function oe(e){e.style.imageRendering="pixelated";const t=e.getContext("2d");t.imageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1}const ne={getInstance:M,globalResize:D,hexToRgb:A,Scroll2dEngine:F,Chevron:P,pixelateCanvas:oe};requestAnimationFrame(function e(t){requestAnimationFrame(e),null==R&&(R=t);const i=t-R;R=t;let o=i/y;Y=1e3/i,isNaN(o)&&(o=1);for(const e in z){const i=z[e];i.render(o),i.update(t,o)}});export{P as Chevron,F as Scroll2dEngine,ne as default,M as getInstance,D as globalResize,A as hexToRgb,oe as pixelateCanvas};