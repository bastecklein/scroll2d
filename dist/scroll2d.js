var e={d:(t,i)=>{for(var o in i)e.o(i,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:i[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};function i(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function o(e){let t;return 6==e.length||7==e.length?(t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e),t?{a:255,r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null):8==e.length||9==e.length?(t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e),t?{a:parseInt(t[1],16),r:parseInt(t[2],16),g:parseInt(t[3],16),b:parseInt(t[4],16)}:null):{a:255,r:0,g:0,b:0}}function s(e,t,i,o){return Math.sqrt((e-i)**2+(t-o)**2)}function n(e,t){const i=e.indexOf(t);return i>-1&&e.splice(i,1),e}function l(e){e.addEventListener("contextmenu",(function(e){return e.preventDefault(),e.stopPropagation(),!1}),{passive:!1}),e.addEventListener("ontouchforcechange",(function(e){return e.preventDefault(),e.stopPropagation(),!1}),{passive:!1}),e.addEventListener("webkitmouseforcewillbegin",(function(e){e.preventDefault(),e.stopPropagation()}),{passive:!1}),e.addEventListener("webkitmouseforcedown",(function(e){e.preventDefault(),e.stopPropagation()}),{passive:!1}),e.addEventListener("webkitmouseforceup",(function(e){e.preventDefault(),e.stopPropagation()}),{passive:!1}),e.addEventListener("webkitmouseforcechanged",(function(e){e.preventDefault(),e.stopPropagation()}),{passive:!1}),e.touchAction="none",e.contentZooming="none",e.msTouchAction="none",e.msContentZooming="none",e.style.touchAction="none",e.style.userSelect="none"}e.d(t,{cL:()=>T,I1:()=>X,Ay:()=>te,iE:()=>R,yD:()=>k,E2:()=>P,Db:()=>ee});const r=[],a=2*Math.PI,h=Math.PI/180;class c{constructor(){this.particles=[],this.offsetX=0,this.offsetY=0,this.middleX=0,this.middleY=0,this.starfieldStarSize=.3,this.starfieldAcceleration=.015,this.starfieldSpeed=.125,this.starfieldTrails=!1,this.starfieldMaxHoldoff=289,this.starfieldGrowth=.00375,this.starfieldPasses=1,this.starfieldColor="#ffffff",this.starfieldRunning=!1,this.rainRunning=!1,this.snowRunning=!1,this.embersRunning=!1,this.rndAngle=0,this.acceleration=0}update(e){(!e||e>20)&&(e=1);let t,o,s,l,a=[],c=[];this.rndAngle+=.002*e;let d=2*(this.middleX-this.offsetX),p=2*(this.middleY-this.offsetY);if(this.starfieldRunning)for(let e=0;e<this.starfieldPasses;e++){let e=i(this.offsetX,d),t=i(this.offsetY,p),o=Math.sqrt(e*e+t*t),s=this.starfieldSpeed/o,n=s*e,l=s*t;1==i(1,2)&&(n=-n),1==i(1,2)&&(l=-l);let r=this.starfieldColor;Array.isArray(this.starfieldColor)&&(r=this.starfieldColor[i(0,this.starfieldColor.length-1)]),c.push({x:this.middleX,y:this.middleY,vx:n,vy:l,size:this.starfieldStarSize,growth:this.starfieldGrowth,color:r,alpha:0,fade:-.025,gravityX:0,gravityY:0,compOp:"screen",trails:this.starfieldTrails,acceleration:this.starfieldAcceleration,holdoffTicks:i(0,this.starfieldMaxHoldoff)})}if(this.rainRunning){let e=i(1,3);for(let t=0;t<e;t++)o=i(this.offsetX,this.offsetX+d),s=i(1,3),s-=.5,l=i(6,14),c.push({x:o,y:this.offsetY,vx:0,vy:l,size:s,color:"#42A5F5",alpha:.3,compOp:"screen",fade:0,trails:!0})}if(this.snowRunning&&2==i(0,5)&&(o=i(this.offsetX,this.offsetX+d),s=i(1,3),s-=.5,l=i(1,6),c.push({x:o,y:this.offsetY,vx:2*Math.sin(this.rndAngle),vy:l,size:s,color:"#ffffff",alpha:.8,compOp:"screen",fade:0,loopsBack:!0,useGlobalAngle:!0})),this.embersRunning&&2==i(0,5)){o=i(this.offsetX,this.offsetX+d),s=i(1,2),s-=.5,l=-i(1,2);let e=2*Math.sin(this.rndAngle);c.push({x:o,y:2*this.middleY,vx:e,vy:l,size:s,color:"#EF6C00",alpha:.6,compOp:"screen",fade:0,loopsBack:!0,useGlobalAngle:!0}),c.push({x:o,y:2*this.middleY,vx:e,vy:l,size:s-.25,color:"#FFECB3",alpha:.85,compOp:"screen",fade:0,loopsBack:!0,useGlobalAngle:!0})}for(let i=0,o=this.particles.length;i<o;i++){if(t=this.particles[i],t.holdoffTicks>0&&(t.holdoffTicks-=e),t.age+=e,null!=t.speed&&null!=t.angle){let e=t.angle*h;t.vx=Math.cos(e)*t.speed,t.vy=Math.sin(e)*t.speed+t.gravityY}t.useGlobalAngle?t.x+=2*Math.sin(this.rndAngle)*e:t.x+=t.vx*e,t.y+=t.vy*e,t.size+=t.growth*e,t.alpha-=t.fade*e,t.vx+=t.gravityX*e,t.vy+=t.gravityY*e,t.alpha<=0||t.size<=0||t.dead?a.push(t):(t.alpha>1&&(t.alpha=1),t.trails&&t.alpha>0&&t.holdoffTicks<=0&&c.push({x:t.x,y:t.y,color:t.color,vx:0,vy:0,gravityX:0,gravityY:0,fade:.25,size:t.size,growth:0,alpha:t.alpha}),t.acceleration>0&&(t.vx+=t.vx*(t.acceleration*e),t.vy+=t.vy*(t.acceleration*e)))}for(;a.length>0;){let e=a.pop();n(this.particles,e),r.length<4e3&&r.push(e)}for(;c.length>0;){let e=c.pop();this.playParticle(e)}}draw(e){let t;e.save(),0==this.offsetX&&0==this.offsetY||e.translate(this.offsetX,this.offsetY);let i=e.canvas;this.middleX=this.offsetX+i.width/2,this.middleY=this.offsetY+i.height/2;for(let o=0,s=this.particles.length;o<s;o++)if(t=this.particles[o],!(t.holdoffTicks>0)){if(t.age>100){if(t.y<this.offsetY||t.y>this.offsetY+i.height){t.dead=!0;continue}if(t.x<this.offsetX||t.x>this.offsetX+i.width){if(!t.loopsBack){t.dead=!0;continue}t.x<this.offsetX?t.x=this.offsetX+i.width:t.x=this.offsetX}}e.save(),e.globalCompositeOperation=t.compOp,e.globalAlpha=t.alpha,e.beginPath(),e.arc(t.x,t.y,t.size,0,a,!1),e.fillStyle=t.color,e.fill(),e.restore()}i=null,e.restore()}reset(){this.particles=[]}playParticle(e){if(this.particles.length>4e3)return;const t=function(e){if(0==r.length)return new d(e);{let t=r.pop();if(!t)return new d(e);t.x=0,t.y=0,t.vx=0,t.vy=0,t.size=1,t.growth=0,t.color="#ff0000",t.alpha=1,t.dead=!1,t.fade=.01,t.age=0,t.gravityX=0,t.gravityY=0,t.compOp="lighter",t.trails=!1,t.loopsBack=!1,t.useGlobalAngle=!1,t.sticks=!1,t.holdoffTicks=0,t.acceleration=0;let o=0,s=0,n=0,l=0;if(e)for(let r in e)"rSize"==r&&(t.size=i(e[r][0],e[r][1])),"rGrowth"==r&&(t.growth=i(e[r][0],e[r][1])),"xDev"!=r&&"yDev"!=r?"rVX"!=r&&"rVY"!=r?t[r]=e[r]:("rVX"==r&&(n=i(0,2*e[r]),n-=e[r]),"rVY"==r&&(l=i(0,2*e[r]),l-=e[r])):("xDev"==r&&(o=i(0,2*e[r]),o-=e[r]),"yDev"==r&&(s=i(0,2*e[r]),s-=e[r]));return t.x+=o,t.y+=s,t.vx+=n,t.vy+=l,t}}(e);this.particles.push(t)}playEffect(e,t,o){if(!p[e])return;let s=p[e];for(let n=0;n<s.length;n++){let l=0;(e=s[n]).count&&(l=e.count),e.rCount&&(l=i(e.rCount[0],e.rCount[1]));for(let s=0;s<l;s++){let s=t,n=o;if(e.prX){let t=i(0,2*e.prX);t-=e.prX,s+=t}if(e.prY){let t=i(0,2*e.prY);t-=e.prY,n+=t}if(null==e.program){let t={};for(let i in e.options)t[i]=e.options[i];t.x=s,t.y=n,this.playParticle(t)}else this.playEffect(e.program,s,n)}}}}class d{constructor(e){this.x=0,this.y=0,this.vx=0,this.vy=0,this.size=1,this.growth=0,this.color="#ff0000",this.alpha=1,this.dead=!1,this.fade=.01,this.age=0,this.gravityX=0,this.gravityY=0,this.compOp="lighter",this.trails=!1,this.loopsBack=!1,this.useGlobalAngle=!1,this.sticks=!1,this.speed=null,this.angle=null,this.holdoffTicks=0;let t=0,o=0,s=0,n=0;if(this.acceleration=0,e)for(let l in e)"rSpeed"!=l?"rAngle"!=l?"xDev"!=l&&"yDev"!=l?"rVX"!=l&&"rVY"!=l?this[l]=e[l]:("rVX"==l&&(s=i(0,2*e[l]),s-=e[l]),"rVY"==l&&(n=i(0,2*e[l]),n-=e[l])):("xDev"==l&&(t.middleXv=i(0,2*e[l]),t-=e[l]),"yDev"==l&&(o=i(0,2*e[l]),o-=e[l])):this.angle=i(e[l][0],e[l][1]):this.speed=i(e[l][0],e[l][1]);this.x+=t,this.y+=o,this.vx+=s,this.vy+=n}}const p={redblast:[{count:14,program:null,options:{rSize:[1,3],color:"#E53935",rVX:8,rVY:8}}],blueblast:[{count:3,program:null,options:{size:7,color:"#1976D2",rVX:2,vy:0,rGrowth:[0,1]}}],yellowblast:[{rCount:[0,1],program:null,options:{rSize:[1,2],color:"#1976D2",rVX:12,rVY:4}},{rCount:[0,1],program:null,options:{rSize:[1,2],color:"#FFB300",rVX:12,rVY:4}},{rCount:[0,1],program:null,options:{rSize:[1,2],color:"#FF6F00",rVX:12,rVY:4}}],purpleblast:[{rCount:[0,1],program:null,options:{rSize:[1,3],color:"#E91E63",rVX:6,rVY:6,sticks:!0}},{rCount:[0,1],program:null,options:{rSize:[1,3],color:"#9C27B0",rVX:6,rVY:6,sticks:!0}},{rCount:[0,1],program:null,options:{rSize:[1,3],color:"#F44336",rVX:6,rVY:6,sticks:!0}}],stab:[{count:1,program:null,options:{size:4,color:"#660000",fade:.02,compOp:"source-over"}}],smallmagic:[{count:1,program:null,options:{size:6,color:"#007acc",fade:.02,compOp:"source-over"}}],leaf:[{count:1,program:null,options:{size:8,color:"#00994d",fade:.02,compOp:"source-over"}}],blunt:[{count:1,program:null,options:{size:16,color:"#333333",fade:.02,compOp:"source-over"}}],bluntspike:[{count:1,program:"blunt",options:null},{count:1,program:"shotgun",options:null}],shotgun:[{count:12,program:null,options:{size:4,color:"#660000",fade:.02,compOp:"source-over",xDev:30,yDev:30}}],explosion:[{count:40,program:null,options:{size:3,color:"#ff9900",fade:.02,rVX:5,rVY:5,growth:-.05}},{count:10,program:null,options:{size:5,color:"#ffe0b3",fade:.02,rVX:5,rVY:5,trails:!0,alpha:.8}},{count:10,program:null,options:{size:1,color:"#ffff66",fade:.04,rVX:5,rVY:5,trails:!0,alpha:.5,growth:.3}},{count:20,program:null,options:{size:1,color:"#ffff66",fade:.01,rVX:5,rVY:5,gravityY:.05,trails:!0,alpha:.5,growth:.05,useGlobalAngle:!0}}],sonicexplosion:[{count:40,program:null,options:{size:5,color:"#000099",fade:.02,rVX:5,rVY:5}},{count:10,program:null,options:{size:5,color:"#660066",fade:.02,rVX:5,rVY:5}},{count:10,program:null,options:{size:5,color:"#9966ff",fade:.02,rVX:5,rVY:5}}],blueexplosion:[{count:40,program:null,options:{rSize:[1,3],color:"#002080",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:10,program:null,options:{rSize:[2,4],color:"#002db3",fade:.02,rSpeed:[1,5],rAngle:[0,360]}},{count:10,program:null,options:{rSize:[3,6],color:"#0039e6",fade:.02,rSpeed:[1,5],rAngle:[0,360]}}],bloodexplosion:[{count:40,program:null,options:{size:5,color:"#F44336",fade:.02,compOp:"source-over",rVX:5,rVY:5}},{count:10,program:null,options:{size:5,color:"#E53935",compOp:"source-over",fade:.02,rVX:5,rVY:5}},{count:10,program:null,options:{size:5,color:"#D32F2F",compOp:"source-over",fade:.02,rVX:5,rVY:5}}],multiexplosion:[{count:0,rCount:[3,8],program:"explosion",options:null,prX:150,prY:150}],flame:[{count:6,program:null,prX:4,prY:2,options:{size:1,color:"#FFD54F",fade:.02,vy:-.6,rvX:20,growth:.15}}],smallrainbowexplosion:[{count:8,program:null,options:{rSize:[1,5],color:"#f44336",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#FF9800",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#FFEB3B",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#4CAF50",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#2196F3",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#3F51B5",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#673AB7",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}}],smallelectricexplosion:[{count:8,program:null,options:{rSize:[1,5],color:"#B3E5FC",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#BBDEFB",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#42A5F5",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#29B6F6",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#1976D2",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#0288D1",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}},{count:8,program:null,options:{rSize:[1,5],color:"#01579B",fade:.02,rSpeed:[1,5],rAngle:[0,360],rGrowth:[0,1]}}],explosionpinks:[{count:40,program:null,options:{size:3,color:"#F8BBD0",fade:.02,rVX:5,rVY:5,growth:-.05}},{count:10,program:null,options:{size:5,color:"#F48FB1",fade:.02,rVX:5,rVY:5,trails:!0,alpha:.8}},{count:10,program:null,options:{size:1,color:"#F06292",fade:.04,rVX:5,rVY:5,trails:!0,alpha:.5,growth:.3}},{count:20,program:null,options:{size:1,color:"#EC407A",fade:.01,rVX:5,rVY:5,gravityY:.05,trails:!0,alpha:.5,growth:.05,useGlobalAngle:!0}}],explosionpindogos:[{count:40,program:null,options:{size:3,color:"#C5CAE9",fade:.02,rVX:5,rVY:5,growth:-.05}},{count:10,program:null,options:{size:5,color:"#9FA8DA",fade:.02,rVX:5,rVY:5,trails:!0,alpha:.8}},{count:10,program:null,options:{size:1,color:"#7986CB",fade:.04,rVX:5,rVY:5,trails:!0,alpha:.5,growth:.3}},{count:20,program:null,options:{size:1,color:"#5C6BC0",fade:.01,rVX:5,rVY:5,gravityY:.05,trails:!0,alpha:.5,growth:.05,useGlobalAngle:!0}}],explosionlightblues:[{count:40,program:null,options:{size:3,color:"#B3E5FC",fade:.02,rVX:5,rVY:5,growth:-.05}},{count:10,program:null,options:{size:5,color:"#81D4FA",fade:.02,rVX:5,rVY:5,trails:!0,alpha:.8}},{count:10,program:null,options:{size:1,color:"#4FC3F7",fade:.04,rVX:5,rVY:5,trails:!0,alpha:.5,growth:.3}},{count:20,program:null,options:{size:1,color:"#29B6F6",fade:.01,rVX:5,rVY:5,gravityY:.05,trails:!0,alpha:.5,growth:.05,useGlobalAngle:!0}}]},u=function(){return new c};window.addEventListener("resize",k);const g=Math.PI,f=2*g,v=g/180,m=.001,S=1e3/60;let w={},x=[],y=[],z=[],C=null,G=0;function R(e){const t=new X(e);return w[t.id]=t,t}class X{constructor(e){const t=this;this.id=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}(),this.scale=e.scale||window.devicePixelRatio||1,this.autoScale=!0,e.scale&&(this.autoScale=!1),this.lastScale=this.scale,this.drawQueue=[],this.aboveFoldDrawQueue=[],this.textPoppers=[],this.lightBlockers=[],this.lightSources=[],this.selectionColor=e.selectionColor||"#4CAF50",this.running=!1,this.changed=!0,this.staticCallMade=!1,this.isometricMode=e.isometricMode||!1,this.fitGridToHeight=e.fitGridToHeight||!1,this.staticMapInit=!1,this.didAMove=!1,this.didMove=!1,this.isDown=!1,this.isHold=!1,this.usingTouch=!1,this.isSelection=!1,this.nextDownSelection=!1,this.usingMouse=!1,this.isPainting=!1,this.isPinching=!1,this.instructionsRecieved=!1,this.doubleHeightTiles=e.doubleHeightTiles||!1,this.useFastRenderMode=e.fastRenderMode||!1,this.pixelated=e.pixelated||!1,this.fullMapRenderCallback=null,this.colorFilter=null,this.filterAmount=0,this.darknessMaskColor=null,this.viewX=0,this.viewY=0,this.actualX=0,this.actualY=0,this.startX=0,this.startY=0,this.holdX=0,this.holdY=0,this.curX=0,this.curY=0,this.selectionX=0,this.selectionY=0,this.selectionTopX=0,this.selectionTopY=0,this.selectionWidth=0,this.selectionHeight=0,this.lastHoverX=0,this.lastHoverY=0,this.lastPaintX=0,this.lastPaintY=0,this.lerpX=0,this.lerpY=0,this.lerpCallback=null,this.lerpSpeed=.15,this.lerpAccuracy=1,this.viewPadding=0,this.zoomLevel=1,this.fpsLimiter=e.fpsLimiter||1,this.fpsCounter=0,this.maxZoom=e.maxZoom||3,this.minZoom=e.minZoom||.1,this.width=0,this.height=0,this.winWidth=0,this.winHeight=0,this.mapWidth=-1,this.mapHeight=-1,this.mapTotalWidth=-1,this.mapTotalHeight=-1,this.gridSize=e.gridSize||40,this.relativeGridSize=this.gridSize,this.halfGridSize=this.gridSize/2,this.halfRelativeGridSize=this.relativeGridSize/2,this.quarterRelativeGridSize=this.relativeGridSize/4,this.twentiethGridSize=this.relativeGridSize/20,this.renderOrder=0,this.staticMaxZIndex=1,this.lastDistance=null,this.pointerListener=e.onPointer||null,this.holdFunction=e.onHold||null,this.selectionFunction=e.onSelection||null,this.selectionProgressFunction=e.onSelectionProgress||null,this.hoverFunction=e.onHover||null,this.paintFunction=e.onPaint||null,this.viewportChangeFunction=e.onViewportChange||null,this.releaseFunction=e.onRelease||null,this.clickFunction=e.onClick||null,this.rightClickFunction=e.onRightClick||null,this.drawFunction=e.onDraw||null,this.updateFunction=e.onUpdate||null,this.paintTimer=null,this.paintTimeoutFunction=null,this.screenshotCanvas=null,this.screenshotContext=null,this.screenshotCallback=null,this.screenshotPhase=!1,this.particleEngine=null,this.holdTimer=null,this.staticMap={},this.limits={xMin:0,xLimit:0,yMin:0,yLimit:0},this.mouseScrolling={up:!1,down:!1,left:!1,right:!1},this.padScrolling={up:!1,down:!1,left:!1,right:!1},this.padRightScrolling={up:!1,down:!1,left:!1,right:!1},this.padTriggers={left:!1,right:!1},this.aDownTime=0,this.pointers={},this.primaryPointer=null,this.pointersDown=0;const i=e.logicFPS||60;this.updateTime=1e3/i,this.lastUpdateUpdate=0,this.gamepadNegotiationTimer=0,this.viewBounds=null,this.holder=null,e.holder?this.holder=e.holder:(this.holder=document.createElement("div"),this.holder.classList.add("scroll2d-holder"),D(this.holder),document.body.appendChild(this.holder)),this.lightCanvas=document.createElement("canvas"),this.lightFinalRenderCanvas=document.createElement("canvas"),this.staticCanvas=document.createElement("canvas"),this.preRenderCanvas=document.createElement("canvas"),this.gradientFilterCanvas=document.createElement("canvas"),this.canvas=document.createElement("canvas"),this.filterOverlay=document.createElement("div"),this.context=this.canvas.getContext("2d"),this.staticContext=this.staticCanvas.getContext("2d"),this.lightContext=this.lightCanvas.getContext("2d"),this.lightFinalRenderContext=this.lightFinalRenderCanvas.getContext("2d"),this.preRenderContext=this.preRenderCanvas.getContext("2d"),this.gradientFilterContext=this.gradientFilterCanvas.getContext("2d"),this.pixelated&&(ee(this.canvas),ee(this.staticCanvas),ee(this.lightCanvas),ee(this.lightFinalRenderCanvas),ee(this.preRenderCanvas),ee(this.gradientFilterCanvas)),this.holder.appendChild(this.canvas),this.holder.appendChild(this.filterOverlay),l(this.canvas),function(e){if(!e||!e.element)return;const t=e.element;let i=!1;e.ignoreOut&&(i=!0),l(t),t.addEventListener("touchstart",(function(e){e.preventDefault(),e.stopPropagation()}),{passive:!1}),t.addEventListener("pointerdown",(function(i){i.preventDefault(),i.stopPropagation();let o="mouse";i.pointerType&&(o=i.pointerType);let s=1;i.pressure&&(s=i.pressure);let n=1;return"mouse"==o&&i.which&&(n=i.which),e.down&&e.down({element:t,id:i.pointerId,x:i.offsetX,y:i.offsetY,type:o,pressure:s,which:n,pageX:i.pageX,pageY:i.pageY}),!1}),{passive:!1}),t.addEventListener("pointermove",(function(i){i.preventDefault(),i.stopPropagation();let o="mouse";i.pointerType&&(o=i.pointerType);let s=1;i.pressure&&(s=i.pressure);let n=1;return"mouse"==o&&i.which&&(n=i.which),e.move&&e.move({element:t,id:i.pointerId,x:i.offsetX,y:i.offsetY,type:o,pressure:s,which:n,pageX:i.pageX,pageY:i.pageY}),!1}),{passive:!1}),i||t.addEventListener("pointerout",(function(i){i.preventDefault(),i.stopPropagation();let o="mouse";i.pointerType&&(o=i.pointerType);let s=1;return"mouse"==o&&i.which&&(s=i.which),e.up&&e.up({element:t,id:i.pointerId,type:o,which:s,evt:"out"}),!1}),{passive:!1}),t.addEventListener("pointerup",(function(i){i.preventDefault(),i.stopPropagation();let o="mouse";i.pointerType&&(o=i.pointerType);let s=1;return"mouse"==o&&i.which&&(s=i.which),e.up&&e.up({element:t,id:i.pointerId,type:o,which:s,evt:"up"}),!1}),{passive:!1})}({element:t.filterOverlay,down:function(e){!function(e,t){let i=t.x,o=t.y,s=i,n=o;e.didAMove=!1,"touch"==t.type?e.usingTouch=!0:e.usingTouch=!1;const l=e.getPointer(t.id,s,n,t.type);l.down=!0,e.pointersDown++,e.isSelection=!1,e.nextDownSelection&&(e.isSelection=!0,e.nextDownSelection=!1),e.actualX=s,e.actualY=n,"mouse"==t.type?(e.usingMouse=!0,t.which&&1!=t.which?l.rightClick=!0:l.rightClick=!1):e.usingMouse=!1,e.pointerListener&&e.pointerListener("down",i,o,t.type,t.which),e.startX=i,e.startY=o,e.didMove=!1,e.isDown=!0,e.isHold=!1,(e.holdFunction||e.selectionFunction)&&(e.holdX=i,e.holdY=o,l.rightClick||e.isSelection?e.selectionFunction&&e.isSelection&&A(e):e.holdTimer=setTimeout((function(){if(e.holdTimer=null,e.didMove=!1,!e.isPainting)if(e.selectionFunction)A(e);else if(e.holdFunction){e.isHold=!0;const t=e.positionToCoords(e.holdX,e.holdY);e.holdFunction(t.x,t.y)}}),700)),e.pointersDown>1&&(e.isSelection=!1,e.holdTimer&&(clearTimeout(e.holdTimer),e.holdTimer=null))}(t,e)},move:function(e){!function(e,t){"touch"==t.type?e.usingTouch=!0:e.usingTouch=!1;const i=e.getPointer(t.id,t.x,t.y,t.type);i.down=!0,e.actualX=t.x,e.actualY=t.y,"mouse"==t.type?e.usingMouse=!0:e.usingMouse=!1;let o=t.x,n=t.y;if(e.pointerListener&&e.pointerListener("move",o,n,t.type,t.which),i.x=o,i.y=n,2==e.pointersDown)return e.didMove=!0,void function(e){if(2!=e.pointersDown||!e.primaryPointer)return;let t,i;for(const o in e.pointers){const s=e.pointers[o];s.down&&(t?i||(i=s):t=s)}if(!t||!i)return;e.isSelection=!1;const o=s(t.x,t.y,i.x,i.y);null!=e.lastDistance?(o>e.lastDistance+3&&(e.doZoom(!0),e.lastDistance=o),o<e.lastDistance-3&&(e.doZoom(!1),e.lastDistance=o)):e.lastDistance=o}(e);let l=0,r=0;e.curX&&(l=e.curX,r=e.curY),e.curX=o,e.curY=n;const a=e.positionToCoords(o,n);if("mouse"!=t.type&&"pen"!=t.type||!e.hoverFunction||(e.lastHoverX=a.x,e.lastHoverY=a.y,e.hoverFunction(a.x,a.y,e.actualX,e.actualY,t.type,a.px,a.py)),e.isDown&&!e.isHold){if(e.isSelection)return e.setSelectionPoints(o,n),void(e.selectionProgressFunction&&e.sendSelectionPointsToFunction(e.selectionProgressFunction));if(e.didMove){if(e.changed=!0,e.isPainting&&e.paintFunction){if(e.lastPaintX==a.x&&e.lastPaintY==a.y)return;return e.lastPaintX=a.x,e.lastPaintY=a.y,void e.paintFunction(a.x,a.y,e.actualX,e.actualY,t.type)}e.didAMove=!0;const i=l-e.curX,o=r-e.curY;e.viewX+=i,e.viewY+=o,e.checkBounds(),e.notifyViewportChange(!0)}else{const t=s(e.startX,e.startY,o,n);let i=6;e.usingTouch&&(i=12),t>i&&(e.didMove=!0,e.holdTimer&&(clearTimeout(e.holdTimer),e.holdTimer=null,e.isHold=!1))}}}(t,e)},up:function(e){!function(e,t){e.didAMove&&(e.didAMove=!1),"touch"==t.type?e.usingTouch=!0:e.usingTouch=!1;const i=e.getPointer(t.id,null,null,t.type);if(i.down&&(e.pointersDown--,i.down=!1),e.holdTimer&&(clearTimeout(e.holdTimer),e.holdTimer=null,e.isHold=!1),i.primary&&(i.primary=!1,e.primaryPointer=null),e.isPinching&&(e.isSelection=!1),e.isPinching=!1,e.isDown){if(e.isHold)return e.isDown=!1,void(e.releaseFunction&&e.releaseFunction());if(e.isPainting=!1,e.pointersDown<=0&&(e.pointers={},e.pointersDown=0,e.primaryPointer=null,e.lastDistance=null),e.isSelection)!function(e){e.isSelection=!1,e.isDown=!1,e.selectionFunction&&e.sendSelectionPointsToFunction(e.selectionFunction)}(e);else{if(!e.didMove&&e.clickFunction){const o=e.positionToCoords(e.startX,e.startY);e.isSelection=!1,e.isDown=!1,e.pointersDown=0;const s=e.actualX,n=e.actualY;"touch"==t.type?setTimeout((function(){e.clickFunction(o.x,o.y,s,n,t.type,o.px,o.py)}),75):(i.rightClick&&e.rightClickFunction?e.rightClickFunction(o.x,o.y,s,n,t.type,o.px,o.py):e.clickFunction(o.x,o.y,s,n,t.type,o.px,o.py),i.rightClick=!1)}e.pointerListener&&e.pointerListener("up",0,0,t.type,t.which),e.isDown=!1,e.didMove=!1,e.actualX=0,e.actualY=0}}}(t,e)}}),this.filterOverlay.addEventListener("wheel",(function(e){e.preventDefault(),function(e,t){if(!e.usingMouse)return;const i=function(e){let t=0,i=0,o=0,s=0;return"detail"in e&&(i=e.detail),"wheelDelta"in e&&(i=-e.wheelDelta/120),"wheelDeltaY"in e&&(i=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),"axis"in e&&e.axis===e.HORIZONTAL_AXIS&&(t=i,i=0),o=10*t,s=10*i,"deltaY"in e&&(s=e.deltaY),"deltaX"in e&&(o=e.deltaX),(o||s)&&e.deltaMode&&(1==e.deltaMode?(o*=40,s*=40):(o*=800,s*=800)),o&&!t&&(t=o<1?-1:1),s&&!i&&(i=s<1?-1:1),{pinX:t,spinY:i,pixelX:o,pixelY:s}}(t);t.deltaY<0&&e.doZoom(!0,i.spinY),t.deltaY>0&&e.doZoom(!1,i.spinY)}(t,e)})),D(this.canvas),D(this.filterOverlay),this.normalizeFilterOverlaySize(),this.gamepadAllStop(),setTimeout((function(){t.running=!0,t.resize()}),200)}destroy(){this.running=!1,this.holder.innerHTML="",delete w[this.id]}render(e){!function(e,t){if(!e.running)return;e.autoScale&&(e.scale=window.devicePixelRatio||1),e.scale!=e.lastScale&&H(e),e.lastScale=e.scale,e.renderOrder=0,e.lightBlockers=[],e.particleEngine&&e.particleEngine.update(t);for(const i of e.textPoppers)i.cashed||(i.y-=2*t,i.alpha-=.03*t);let i=null,l=null;if(e.fullMapRenderCallback){const t=e.mapWidth*e.gridSize,o=e.mapHeight*e.gridSize;i=document.createElement("canvas"),l=i.getContext("2d"),e.pixelated&&ee(i),i.width=t/2,i.height=o/2,e.isometricMode&&(i.height=o/4)}if(e.fpsCounter++,e.fpsCounter<e.fpsLimiter)return;if(e.fpsCounter=0,e.instructionsRecieved=!1,e.drawFunction){let t=!1;l&&(t=!0),e.drawFunction(t)}if(!e.instructionsRecieved)return;if(e.changed&&(e.staticContext.clearRect(0,0,e.width,e.height),e.staticContext.save(),e.staticContext.translate(-e.viewX,-e.viewY),function(e,t){if(!e.staticCallMade)return;e.viewBounds||e.setViewBounds();let i=e.viewBounds.minX,o=e.viewBounds.minY,s=e.viewBounds.maxX,n=e.viewBounds.maxY;t&&(i=0,o=0,s=e.mapWidth,n=e.mapHeight);for(let t=0;t<=e.staticMaxZIndex;t++)for(let l=i;l<=s;l++)for(let i=o;i<=n;i++){const o=e.getStaticItem(l,i,t);o&&o.img&&e.staticContext.drawImage(o.img,o.x,o.y,o.w,o.h)}}(e,l),e.staticContext.restore(),e.changed=!1),e.context.clearRect(0,0,e.width,e.height),e.context.globalCompositeOperation="source-over",e.staticCanvas&&e.staticCanvas.width>0&&e.context.drawImage(e.staticCanvas,0,0),e.drawQueue.length>0)for(e.drawQueue.sort(V);e.drawQueue.length>0;){const t=e.drawQueue.pop();W(e,t,e.context,l),x.push(t)}if(e.context.globalAlpha=1,e.lightSources.length>0||null!=e.colorFilter){if(null!=e.colorFilter&&e.filterAmount>0){const t=o(e.colorFilter);e.darknessMaskColor="rgba("+t.r+","+t.g+","+t.b+","+e.filterAmount+")"}else e.darknessMaskColor=null;let t="rgba(255,255,255,0)";for(null!=e.darknessMaskColor&&(t=e.darknessMaskColor),e.lightContext.fillStyle=t,e.lightContext.clearRect(0,0,e.width,e.height),e.lightContext.fillRect(0,0,e.width,e.height),e.lightFinalRenderContext.clearRect(0,0,e.width,e.height);e.lightSources.length>0;){const t=e.lightSources.pop(),i=t.x-e.viewX+.5|0,o=t.y-e.viewY+.5|0,s=t.radius;O(e,e.lightContext,i,o,s,"rgba("+t.color.r+","+t.color.g+","+t.color.b+","+t.intensity+")","rgba("+t.color.r+","+t.color.g+","+t.color.b+",0)"),z.push(t)}e.canvas&&e.width>0&&e.height>0&&(e.lightFinalRenderContext.globalCompositeOperation="source-over",e.lightFinalRenderContext.drawImage(e.canvas,0,0)),e.lightCanvas&&e.width>0&&e.height>0&&(e.lightFinalRenderContext.globalCompositeOperation="source-in",e.lightFinalRenderContext.drawImage(e.lightCanvas,0,0)),e.context.save(),e.context.globalCompositeOperation="multiply",e.context.drawImage(e.lightFinalRenderCanvas,0,0),e.context.restore()}if(e.aboveFoldDrawQueue.length>0)for(e.aboveFoldDrawQueue.sort(V);e.aboveFoldDrawQueue.length>0;){const t=e.aboveFoldDrawQueue.pop();W(e,t,e.context,l),x.push(t)}e.particleEngine&&e.particleEngine.draw(e.context),e.screenshotPhase&&(e.screenshotPhase=!1,e.changed=!0,e.screenshotContext.drawImage(e.canvas,0,0),e.screenshotCallback&&e.screenshotCallback(e.screenshotCanvas),e.screenshotCanvas=null,e.screenshotContext=null,e.screenshotCallback=null);const r=[];for(const t of e.textPoppers)t.cashed?r.push(t):I(e,e.context,t);for(;r.length>0;){const t=r.pop();n(e.textPoppers,t),y.push(t)}if(e.isSelection&&!e.isPinching&&(e.context.save(),e.context.globalAlpha=1,e.context.lineWidth=4,e.context.strokeStyle=e.selectionColor,e.context.strokeRect(e.selectionTopX,e.selectionTopY,e.selectionWidth,e.selectionHeight),e.context.restore()),e.fullMapRenderCallback&&i){const t=e.fullMapRenderCallback,o=new Image;o.onload=function(){t(o)},o.src=i.toDataURL("image/png")}if(e.fullMapRenderCallback=null,e.lerpCallback){const t=e.getCenterPosition();if(s(t.px,t.py,e.lerpX,e.lerpY)<e.lerpAccuracy){const t=e.lerpCallback;e.lerpX=0,e.lerpY=0,e.lerpCallback=null,e.lerpSpeed=.15,e.lerpAccuracy=1,t()}else{let i=(e.lerpX-t.px)*e.lerpSpeed,o=(e.lerpY-t.py)*e.lerpSpeed;i>0&&i<m&&(i=m),i<0&&i>-.001&&(i=-.001),o>0&&o<m&&(o=m),o<0&&o>-.001&&(o=-.001);const s=t.px+i,n=t.py+o;e.centerOnCoord(s,n)}}}(this,e)}resize(){H(this)}setMapDimensions(e,t){if(this.mapWidth=e,this.mapHeight=t,null==e||null==t||e<0||t<0)return this.mapWidth=-1,this.mapHeight=-1,this.mapTotalWidth=-1,this.mapTotalHeight=-1,void this.setLimits();this.mapTotalWidth=this.mapWidth*this.relativeGridSize,this.mapTotalHeight=this.mapHeight*this.relativeGridSize,this.setLimits(),this.drawQueue=[],this.aboveFoldDrawQueue=[],this.staticCallMade&&this.initStaticMap(),this.changed=!0}setLimits(){this.mapWidth>0&&this.mapHeight>0?this.isometricMode?(this.limits.xMin=-this.mapTotalWidth/2-this.relativeGridSize,this.limits.xLimit=this.mapTotalWidth/2-this.winWidth+2*this.relativeGridSize,this.limits.yMin=-this.relativeGridSize,this.limits.yLimit=this.mapTotalHeight/2-this.winHeight+2*this.relativeGridSize):(this.limits.xMin=0-this.winWidth/2,this.limits.xLimit=this.mapTotalWidth-this.winWidth/2,this.limits.yMin=0-this.winHeight/2,this.limits.yLimit=this.mapTotalHeight-this.winHeight/2,this.fitGridToHeight&&(this.limits.yMin=0,this.limits.yLimit=0)):(this.limits.xMin=-99999999,this.limits.xLimit=99999999,this.limits.yMin=-99999999,this.limits.yLimit=99999999)}setRelativeGridSize(){this.relativeGridSize=Math.round(this.gridSize*this.zoomLevel),this.relativeGridSize%2!=0&&this.relativeGridSize++,this.halfGridSize=this.gridSize/2,this.halfRelativeGridSize=this.relativeGridSize/2,this.quarterRelativeGridSize=this.relativeGridSize/4,this.twentiethGridSize=this.relativeGridSize/20}setViewBounds(){const e=this.positionToCoords(0-this.viewPadding,0-this.viewPadding),t=this.positionToCoords(this.winWidth+this.viewPadding,this.winHeight+this.viewPadding);if(this.isometricMode){const i=this.positionToCoords(this.winWidth+this.viewPadding,0-this.viewPadding),o=this.positionToCoords(0-this.viewPadding,this.winHeight+this.viewPadding);this.viewBounds=new M(e.x,i.y,t.x,o.y,this)}else this.viewBounds=new M(e.x,e.y,t.x,t.y,this)}getViewBounds(){return null==this.viewBounds&&this.setViewBounds(),this.viewBounds}initStaticMap(){this.staticMap={},this.staticMapInit=!0}positionToCoords(e,t){return new Y(e,t,this)}getPointer(e,t,i,o){if(this.pointers[e])return this.pointers[e];const s={x:t,y:i,lastX:t,lastY:i,origX:t,origY:i,primary:!1,type:o,rightClick:!1,down:!1};return 0===this.pointersDown&&(s.primary=!0,this.primaryPointer=s),this.pointers[e]=s,s}setSelectionPoints(e,t){e<this.selectionX?(this.selectionTopX=e,this.selectionWidth=this.selectionX-e):(this.selectionTopX=this.selectionX,this.selectionWidth=e-this.selectionX),t<this.selectionY?(this.selectionTopY=t,this.selectionHeight=this.selectionY-t):(this.selectionTopY=this.selectionY,this.selectionHeight=t-this.selectionY)}sendSelectionPointsToFunction(e){const t=this.selectionTopX+this.selectionWidth,i=this.selectionTopY+this.selectionHeight;e(this.getCoordAndActual(this.selectionTopX,this.selectionTopY),this.getCoordAndActual(t,this.selectionTopY),this.getCoordAndActual(this.selectionTopX,i),this.getCoordAndActual(t,i))}getCoordAndActual(e,t){const i={aX:e,aY:t,x:e,y:t},o=this.positionToCoords(e,t);return i.x=o.x,i.y=o.y,i}checkBounds(){this.viewX<this.limits.xMin&&(this.viewX=this.limits.xMin),this.viewX>this.limits.xLimit&&(this.viewX=this.limits.xLimit),this.viewY<this.limits.yMin&&(this.viewY=this.limits.yMin),this.viewY>this.limits.yLimit&&(this.viewY=this.limits.yLimit),this.setViewBounds()}notifyViewportChange(e=!1){this.viewportChangeFunction&&this.viewportChangeFunction(e)}doZoom(e,t){let i=this.zoomLevel;t?(t>.15&&(t=.15),t<-.15&&(t=-.15),e?i<this.maxZoom&&(i-=i*t):i>this.minZoom&&(i-=i*t)):e&&(i<this.maxZoom?i+=.15:i>this.minZoom&&(i-=.15)),this.setZoomLevel(i)}setZoomLevel(e){const t=this.getCenterPosition();this.zoomLevel=e,this.zoomLevel>=.9&&this.zoomLevel<=1.1&&(this.zoomLevel=1),this.zoomLevel>this.maxZoom&&(this.zoomLevel=this.maxZoom),this.zoomLevel<this.minZoom&&(this.zoomLevel=this.minZoom),this.setRelativeGridSize(),this.instructionsRecieved=!0,this.changed=!0,this.forceSceneChange(),this.centerOnCoord(t.x,t.y),this.notifyViewportChange(!0)}getCenterPosition(){return this.positionToCoords(this.winWidth/2,this.winHeight/2)}forceSceneChange(){this.setMapDimensions(this.mapWidth,this.mapHeight),this.initStaticMap(),this.setRelativeGridSize(),this.notifyViewportChange(!0),this.changed=!0}centerOnCoord(e,t,i=!1){i?(this.viewX=e-this.winWidth/2,this.viewY=t-this.winHeight/2):(this.lastHoverX=e,this.lastHoverY=t,this.isometricMode?(this.viewX=(e-t)*this.halfRelativeGridSize-this.winWidth/2,this.viewY=(e+t)*this.quarterRelativeGridSize-this.winHeight/2):(this.viewX=Math.floor(e*this.relativeGridSize+this.halfRelativeGridSize-this.winWidth/2),this.viewY=Math.floor(t*this.relativeGridSize+this.halfRelativeGridSize-this.winHeight/2))),this.fitGridToHeight&&(this.viewY=0),this.checkBounds(),this.changed=!0}getStaticItem(e,t,i){return this.staticMapInit?(this.staticMap[i]||(this.staticMap[i]={}),this.staticMap[i][e]||(this.staticMap[i][e]={}),this.staticMap[i][e][t]?this.staticMap[i][e][t]:null):null}setStaticItem(e,t,i,o){if(!this.staticMapInit)return null;this.staticMap[i]||(this.staticMap[i]={}),this.staticMap[i][e]||(this.staticMap[i][e]={}),this.staticMap[i][e][t]=o}setNextDownInSelection(e){this.nextDownSelection=e}drawStaticTile(e,t,i,o){!function(e,t,i,o,s){if(null==t)return;if(i<0||i>e.mapWidth)return;if(o<0||o>e.mapHeight)return;if(s||(s=0),s>e.staticMaxZIndex&&(e.staticMaxZIndex=s,e.initStaticMap(),e.changed=!0),e.fullMapRenderCallback)return void N(e,t,i,o,s,!1,1);e.staticCallMade=!0,e.staticMapInit||e.initStaticMap(),e.instructionsRecieved=!0;const n=e.getStaticItem(i,o,s);null==n?(e.setStaticItem(i,o,s,U(e,t,i,o)),e.changed=!0):n.img!=t&&(e.setStaticItem(i,o,s,U(e,t,i,o,n)),e.changed=!0)}(this,e,t,i,o)}drawTile(e,t,i,o,s,n){return N(this,e,t,i,o,s,n)}drawSprite(e,t,i,o=t,s=i,n=0,l=null,r="#ff0000",a=1,h=0,c=1,d=1,p=null,u=0,g=!1,f=null,v=0,m=1,S=20,w=null,x=0,y=0,z=0){return $(this,e,t,i,o,s,n,l,r,a,h,c,d,p,u,g,f,v,m,S,w,x,y,z)}drawSpriteWithOptions(e){const t=e.img||null,i=e.x||0,o=e.y||0;return $(this,t,i,o,e.tX||i,e.tY||o,e.step||0,e.meterPercent||null,e.meterColor||"#ff0000",e.alpha||1,e.zIndex||0,e.tileWidth||1,e.tileHeight||1,e.chevrons||null,e.angle||0,e.centerChevrons||!1,e.textLabel||null,e.yOffset||0,e.scale||1,e.textSize||20,e.textFont||null,e.textYOffset||0,e.meterYOffset||0,e.elevation||0)}checkVisibility(e,t){let i,o;this.isometricMode?(i=(e-t)*this.halfRelativeGridSize,o=(e+t)*this.quarterRelativeGridSize):(i=e*this.relativeGridSize,o=t*this.relativeGridSize);const s=this.relativeGridSize+this.viewPadding;return i>this.viewX-s&&i<this.winWidth+this.viewX+s&&o>this.viewY-s&&o<this.winHeight+this.viewY+s}lerpToCoord(e,t,i,o=.15,s=1){this.lerpX=e,this.lerpY=t,this.lerpCallback=i,this.lerpSpeed=o,this.lerpAccuracy=s}setViewPadding(e){this.viewPadding=e}setGridSize(e){const t=this.getCenterPosition();this.gridSize=e,this.setRelativeGridSize(),this.changed=!0,H(this),this.centerOnCoord(t.x,t.y)}setDoubleHeightTiles(e){this.doubleHeightTiles=e}setDrawFunction(e){this.drawFunction=e}setClickFunction(e){this.clickFunction=e}setPointerListener(e){this.pointerListener=e}setRightClickFunction(e){this.rightClickFunction=e}setViewportChangeFunction(e){this.viewportChangeFunction=e}setHoverFunction(e){this.hoverFunction=e}setHoldFunction(e){this.holdFunction=e}setReleaseFunction(e){this.releaseFunction=e}setPaintFunction(e){this.paintFunction=e}setSelectionFunction(e,t,i){this.selectionFunction=e,this.selectionProgressFunction=t,this.selectionColor=i}alertPainting(e=null,t=600){this.isPainting=!0,this.paintTimeoutFunction=e,this.paintTimer&&clearTimeout(this.paintTimer);const i=this;this.paintTimer=setTimeout((function(){i.clearOutPaint()}),t)}clearOutPaint(e=!1){this.isPainting=!1,this.paintTimer&&clearTimeout(this.paintTimer),this.paintTimer=null,e||this.paintTimeoutFunction&&this.paintTimeoutFunction()}popText(e,t,i,o="#FF0000"){!function(e,t,i,o,s){let n,l;if(e.isometricMode){const o=(t-i)*e.halfRelativeGridSize,s=(t+i)*e.quarterRelativeGridSize;n=o-e.halfRelativeGridSize+e.halfRelativeGridSize,l=s+e.halfRelativeGridSize-e.relativeGridSize+e.halfRelativeGridSize}else n=t*e.relativeGridSize+e.halfRelativeGridSize,l=i*e.relativeGridSize+e.halfRelativeGridSize;let r=null;0==y.length?r=new b(n,l,o,s):(r=y.pop(),r.x=n,r.y=l,r.text=o,r.color=s,r.cashed=!1,r.alpha=1),e.textPoppers.push(r)}(this,e,t,i,o)}drawSquare(e,t,i,o=0,s=null){!function(e,t,i,o,s,n){if(!e.drawQueue)return;if(!e.checkVisibility(i,o)&&!e.fullMapRenderCallback)return;e.instructionsRecieved=!0;let l=o;const r=j(e);if(r.isSquare=!0,r.color=t,r.img=n,e.isometricMode){l+=i;const t=(i-o)*e.halfRelativeGridSize,s=(i+o)*e.quarterRelativeGridSize;r.x=t,r.y=s}else r.x=i*e.relativeGridSize,r.y=o*e.relativeGridSize;r.nearness=l,r.zIndex=s,e.drawQueue.push(r)}(this,e,t,i,o,s)}drawText(e,t,i,o="#ffffff",s="#000000",n=20,l=null,r=1){!function(e,t,i,o,s,n,l,r,a){const h=j(e);e.isometricMode?(h.x=(i-o)*e.halfRelativeGridSize,h.y=(i+o)*e.quarterRelativeGridSize):(h.x=i*e.relativeGridSize+e.halfRelativeGridSize,h.y=o*e.relativeGridSize+e.halfRelativeGridSize),h.isText=t,h.lineWidth=l,h.textFont=r,h.zIndex=a,h.color=s,h.barColor=n,e.drawQueue.push(h)}(this,e,t,i,o,s,n,l,r)}setSnowing(e){this.particleEngine&&(this.particleEngine.rainRunning=e)}setEmbers(e){this.particleEngine&&(this.particleEngine.embersRunning=e)}setRaining(e){this.particleEngine&&(this.particleEngine.rainRunning=e)}renderFullMap(e){this.setZoomLevel(1),this.fullMapRenderCallback=e}setIsometric(e){this.isometricMode=e,this.changed=!0}getFPS(){return G}setUpdateFunction(e,t=60){this.updateFunction=e,this.updateTime=1e3/t}update(e,t){!function(e,t,i){if(e.lightSources=[],(e.mouseScrolling.up||e.mouseScrolling.down||e.mouseScrolling.left||e.mouseScrolling.right)&&(e.changed=!0,e.mouseScrolling.up&&(e.viewY-=40*i),e.mouseScrolling.down&&(e.viewY+=40*i),e.mouseScrolling.left&&(e.viewX-=40*i),e.mouseScrolling.right&&(e.viewX+=40*i),e.checkBounds(),e.notifyViewportChange(!0)),e.gamepadNegotiationTimer+=i,e.gamepadNegotiationTimer>=4&&(e.gamepadNegotiationTimer=0,function(e){let t=!1;!e.padScrolling.up||e.padScrolling.down||e.padScrolling.left||e.padScrolling.right||(e.lastHoverY--,e.isometricMode&&e.lastHoverX--,t=!0),!e.padScrolling.down||e.padScrolling.up||e.padScrolling.left||e.padScrolling.right||(e.lastHoverY++,e.isometricMode&&e.lastHoverX++,t=!0),!e.padScrolling.left||e.padScrolling.right||e.padScrolling.up||e.padScrolling.down||(e.lastHoverX--,e.isometricMode&&e.lastHoverY++,t=!0),!e.padScrolling.right||e.padScrolling.left||e.padScrolling.up||e.padScrolling.down||(e.lastHoverX++,e.isometricMode&&e.lastHoverY--,t=!0),e.padScrolling.up&&!e.padScrolling.down&&!e.padScrolling.left&&e.padScrolling.right&&(e.lastHoverY--,e.isometricMode&&e.lastHoverX++,t=!0),e.padScrolling.down&&!e.padScrolling.up&&!e.padScrolling.left&&e.padScrolling.right&&(e.lastHoverY++,e.isometricMode&&e.lastHoverX--,t=!0),e.padScrolling.left&&!e.padScrolling.right&&!e.padScrolling.up&&e.padScrolling.down&&(e.lastHoverX--,e.isometricMode&&e.lastHoverY--,t=!0),e.padScrolling.right&&!e.padScrolling.left&&!e.padScrolling.up&&e.padScrolling.down&&(e.lastHoverX++,e.isometricMode&&e.lastHoverY++,t=!0),t&&e.hoverFunction&&(e.hoverFunction(e.lastHoverX,e.lastHoverY,0,0,"gamepad",e.lastHoverX,e.lastHoverY),e.centerOnCoord(e.lastHoverX,e.lastHoverY));let i=!1;e.padRightScrolling.left&&(e.viewX-=40,i=!0),e.padRightScrolling.right&&(e.viewX+=40,i=!0),e.padRightScrolling.up&&(e.viewY-=40,i=!0),e.padRightScrolling.down&&(e.viewY+=40,i=!0),i&&(e.changed(),e.notifyViewportChange(!0),e.checkBounds()),e.padTriggers.right&&!e.padTriggers.left&&e.doZoom(!0),e.padTriggers.left&&!e.padTriggers.right&&e.doZoom(!1)}(e)),!e.updateFunction)return;let o=0;o=isNaN(e.lastUpdateUpdate)?1e3:t-e.lastUpdateUpdate;const s=o/e.updateTime;o>=e.updateTime&&(e.lastUpdateUpdate=t,e.updateFunction(t,s))}(this,e,t)}setFitGridToHeight(e){this.fitGridToHeight=e,H(this)}setColorFilter(e=null,t=.1){this.darknessMaskColor=null,this.colorFilter=e,this.filterAmount=t,this.changed=!0}initParticleEngine(){this.particleEngine=u()}playParticleEffect(e,t,i){if(!this.particleEngine)return;let o,s;this.isometricMode?(o=(t-i)*this.halfRelativeGridSize,s=(t+i)*this.quarterRelativeGridSize):(o=t*this.relativeGridSize,s=i*this.relativeGridSize);const n=o-this.viewX,l=s-this.viewY;this.particleEngine.playEffect(e,n,l)}drawLine(e,t,i,o,s,n=0,l=!1,r=1,a=!1){!function(e,t,i,o,s,n,l,r,a,h){if(!e.drawQueue)return;e.instructionsRecieved=!0;const c=2*i+2*o+l,d=j(e);if(d.isLine=!0,d.color=t,d.alpha=1,d.lineWidth=a,d.zIndex=l,d.dashedLine=h,e.isometricMode){const t=(i-o)*e.halfRelativeGridSize,l=(i+o)*e.quarterRelativeGridSize,a=(s-n)*e.halfRelativeGridSize,h=(s+n)*e.quarterRelativeGridSize;d.x=t,d.y=l,d.w=a,d.h=h,r&&(d.y+=e.quarterRelativeGridSize,d.h+=e.quarterRelativeGridSize)}else d.x=i*e.relativeGridSize,d.y=o*e.relativeGridSize,d.w=s*e.relativeGridSize,d.h=n*e.relativeGridSize,r&&(d.x+=e.halfRelativeGridSize,d.y+=e.halfRelativeGridSize,d.w+=e.halfRelativeGridSize,d.h+=e.halfRelativeGridSize);d.nearness=c,e.drawQueue.push(d)}(this,e,t,i,o,s,n,l,r,a)}drawCircle(e,t,i,o,s=0,n=1,l=!1){!function(e,t,i,o,s,n,l,r){const a=j(e);a.isCircle=!0,a.color=t,a.alpha=1,a.lineWidth=l,a.zIndex=n,a.dashedLine=r,a.h=s*e.relativeGridSize/2;let h=o;e.isometricMode?(h+=i,a.x=(i-o)*e.halfRelativeGridSize,a.y=(i+o)*e.quarterRelativeGridSize,a.y+=e.quarterRelativeGridSize):(a.x=i*e.relativeGridSize,a.y=o*e.relativeGridSize,a.x+=e.halfRelativeGridSize,a.y+=e.halfRelativeGridSize),a.nearness=h+.56,e.drawQueue.push(a)}(this,e,t,i,o,s,n,l)}setBorderColor(e){e?(this.style.border="4px solid "+e,this.filterOverlay.style.top="0px",this.filterOverlay.style.left="0px",this.filterOverlay.style.width="calc(100% - 8px)",this.filterOverlay.style.height="calc(100% - 8px)"):(this.filterOverlay.style.border="none",this.normalizeFilterOverlaySize())}normalizeFilterOverlaySize(){this.filterOverlay.style.top="0px",this.filterOverlay.style.left="0px",this.filterOverlay.style.width="100%",this.filterOverlay.style.height="100%"}outlineTileGroup(e,t,i,o,s,n=0){const l=function(e){let t,i,o,s,n,l,r,a;const h=[];for(t=0;t<e.length;t++){for(o=e[t],n=!0,l=!0,r=!0,a=!0,i=0;i<e.length;i++)s=e[i],o!=s&&(o.x==s.x&&(s.y==o.y-1&&(n=!1),s.y==o.y+1&&(r=!1)),o.y==s.y&&(s.x==o.x-1&&(a=!1),s.x==o.x+1&&(l=!1)));n&&h.push({x1:o.x,y1:o.y,x2:o.x+1,y2:o.y}),l&&h.push({x1:o.x+1,y1:o.y,x2:o.x+1,y2:o.y+1}),r&&h.push({x1:o.x,y1:o.y+1,x2:o.x+1,y2:o.y+1}),a&&h.push({x1:o.x,y1:o.y,x2:o.x,y2:o.y+1})}return h}(e);for(const e of l)this.drawLine(i,e.x1-n,e.y1-n,e.x2+n,e.y2+n,t,!1,o,s)}setFastRenderMode(e){this.useFastRenderMode=e}getZoomLevel(){return this.zoomLevel}setMaxZoomLevel(e){this.maxZoom=e}setMinZoomLevel(e){this.minZoom=e}startPan(e){this.mouseScrolling[e]=!0}endPan(e){this.mouseScrolling[e]=!1}takeScreenshot(e){this.screenshotCanvas=document.createElement("canvas"),this.screenshotContext=this.screenshotCanvas.getContext("2d"),this.pixelated&&ee(this.screenshotCanvas),this.screenshotCanvas.width=this.width,this.screenshotCanvas.height=this.height,this.screenshotCallback=e,this.screenshotPhase=!0}setFPSLimiter(e){this.fpsLimiter=e}modifyViewX(e){this.viewX+=e,this.checkBounds(),this.changed=!0,this.notifyViewportChange()}modifyViewY(e){this.viewY+=e,this.checkBounds(),this.changed=!0,this.notifyViewportChange()}getUsingTouch(){return this.usingTouch}gamepadDown(e){!function(e,t){"lt"==t&&(e.padTriggers.left=!0),"rt"==t&&(e.padTriggers.right=!0),"up"==t&&(e.padScrolling.up=!0,e.padScrolling.down=!1),"down"==t&&(e.padScrolling.down=!0,e.padScrolling.up=!1),"left"==t&&(e.padScrolling.left=!0,e.padScrolling.right=!1),"right"==t&&(e.padScrolling.right=!0,e.padScrolling.left=!1),"rup"==t&&(e.padRightScrolling.up=!0),"rdown"==t&&(e.padRightScrolling.down=!0),"rleft"==t&&(e.padRightScrolling.left=!0),"rright"==t&&(e.padRightScrolling.right=!0),"a"==t&&(e.aDownTime=(new Date).getTime())}(this,e)}gamepadUp(e){!function(e,t){"lt"==t&&(e.padTriggers.left=!1),"rt"==t&&(e.padTriggers.right=!1),"up"==t&&(e.padScrolling.up=!1),"down"==t&&(e.padScrolling.down=!1),"left"==t&&(e.padScrolling.left=!1),"right"==t&&(e.padScrolling.right=!1),"rup"==t&&(e.padRightScrolling.up=!1),"rdown"==t&&(e.padRightScrolling.down=!1),"rleft"==t&&(e.padRightScrolling.left=!1),"rright"==t&&(e.padRightScrolling.right=!1),"a"==t&&((new Date).getTime()-e.aDownTime<400&&e.clickFunction&&e.clickFunction(e.lastHoverX,e.lastHoverY,0,0,"gamepad",e.lastHoverX,e.lastHoverY),e.aDownTime=0)}(this,e)}drawLight(e,t,i=this.relativeGridSize,s="#ffffff",n=e,l=t,r=0,a=.2){!function(e,t,i,s,n,l,r,a,h){if(!e.checkVisibility(t,i)&&!e.fullMapRenderCallback)return;const c=o(n),d=s*e.relativeGridSize;let p=t,u=i;if(e.isometricMode?(p=(t-i)*e.halfRelativeGridSize,u=(t+i)*e.quarterRelativeGridSize):(p=t*e.relativeGridSize,u=i*e.relativeGridSize+e.relativeGridSize-e.halfRelativeGridSize),t!=l||i!=r){const o=e.twentiethGridSize*a;e.isometricMode?(l>t&&(p+=o/2,u+=o/4),l<t&&(p-=o/2,u-=o/4),r>i&&(p-=o/2,u+=o/4),r<i&&(p+=o/2,u-=o/4)):(l>t&&(p+=o),l<t&&(p-=o),r>i&&(u+=o),r<i&&(u-=o))}e.lightSources.push(function(e,t,i,o,s){if(z.length>0){const n=z.pop();return n.x=e,n.y=t,n.radius=i,n.color=o,n.intensity=s,n}return new L(e,t,i,o,s)}(p,u,d,c,h))}(this,e,t,i,s,n,l,r,a)}gamepadAllStop(){for(const e in this.padScrolling)this.padScrolling[e]=!1;for(const e in this.padRightScrolling)this.padRightScrolling[e]=!1;for(const e in this.padTriggers)this.padTriggers[e]=!1;this.aDownTime=0}getCanvasStream(e=25){return this.canvas.captureStream(e)}getDrawCanvas(){return this.canvas}}class Y{constructor(e,t,i){this.x=e,this.y=t,this.px=e,this.py=t,i&&(i.isometricMode?(this.px=((e+i.viewX)/i.halfRelativeGridSize+(t+i.viewY)/i.quarterRelativeGridSize)/2,this.py=((t+i.viewY)/i.quarterRelativeGridSize-(e+i.viewX)/i.halfRelativeGridSize)/2):(this.px=(e+i.viewX)/i.relativeGridSize,this.py=(t+i.viewY)/i.relativeGridSize)),this.x=Math.floor(this.px),this.y=Math.floor(this.py)}}class M{constructor(e,t,i,o,s){this.minX=e,this.minY=t,this.maxX=i,this.maxY=o,s&&s.mapWidth>0&&s.mapHeight>0&&(this.minX<0&&(this.minX=0),this.minY<0&&(this.minY=0),this.maxX>s.mapWidth&&(this.maxX=s.mapWidth),this.maxY>s.mapHeight&&(this.maxY=s.mapHeight))}}class F{constructor(){this.x=0,this.y=0,this.img=null,this.w=0,this.h=0,this.alpha=null,this.isBar=!1,this.barWidth=0,this.meterWidth=0,this.barColor="#000000",this.isSquare=!1,this.isLine=!1,this.isCircle=!1,this.color="#000000",this.nearness=0,this.tileWidth=1,this.tileHeight=1,this.zIndex=0,this.altitude=0,this.segmentX=-1,this.cX=0,this.cY=0,this.destSegX=0,this.sW=0,this.sH=0,this.blocksLight=!1,this.ro=0,this.lineWidth=1,this.angle=0,this.tX=0,this.tY=0,this.dashedLine=!1,this.isText=null,this.textFont=null}}class T{constructor(e=null,t=null){this.color=e,this.image=t}}class b{constructor(e,t,i,o){this.x=e,this.y=t,this.text=i,this.color=o,this.alpha=1,this.cashed=!1}}class L{constructor(e,t,i,o,s){this.x=e,this.y=t,this.radius=i,this.color=o,this.intensity=s}}function k(){for(const e in w)w[e].resize()}function P(e){return o(e)}function H(e){e.canvas&&(e.changed=!0,e.winWidth=e.holder.offsetWidth,e.winHeight=e.holder.offsetHeight,e.width=Math.round(e.winWidth*e.scale),e.height=Math.round(e.winHeight*e.scale),e.canvas.width=e.width,e.canvas.height=e.height,e.staticCanvas.width=e.width,e.staticCanvas.height=e.height,e.lightCanvas.width=e.width,e.lightCanvas.height=e.height,e.lightFinalRenderCanvas.width=e.width,e.lightFinalRenderCanvas.height=e.height,e.fitGridToHeight&&e.mapHeight>0&&(e.gridSize=e.winHeight/e.mapHeight),e.setRelativeGridSize(),e.mapTotalWidth=e.mapWidth*e.relativeGridSize,e.mapTotalHeight=e.mapHeight*e.relativeGridSize,e.setLimits(),e.setViewBounds(),e.changed=!0)}function D(e){e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.overflow="hidden"}function A(e){e.isSelection=!0,e.selectionX=e.holdX,e.selectionY=e.holdY,e.setSelectionPoints(e.holdX,e.holdY),e.selectionProgressFunction&&e.sendSelectionPointsToFunction(e.selectionProgressFunction)}function V(e,t){return t.zIndex>e.zIndex?1:t.zIndex<e.zIndex?-1:t.nearness>e.nearness?1:t.nearness<e.nearness?-1:t.cX>e.cX?1:t.cX<e.cX?-1:t.cY>e.cY?1:t.cY<e.cY?-1:t.ro>e.ro?1:t.ro<e.ro?-1:0}function W(e,t,i,o){let s,n;if(e.isometricMode?(s=t.x-e.viewX,n=t.y-e.viewY):(s=t.x-e.viewX+.5|0,n=t.y-e.viewY+.5|0),!o||t.isLine||t.isCircle||!(s+t.w<0||n+t.h<0||s>e.width||n>e.height)){if(!t.isLine||!(s>e.winWidth||n>e.winHeight)){if(t.blocksLight&&!e.isometricMode){let t=n;e.doubleHeightTiles&&(t+=e.relativeGridSize),e.lightBlockers.push({x:s,y:t})}t.isText?function(e,t,i,o,s){const n=i.lineWidth*e.zoomLevel*e.scale;t.setLineDash([]),t.textBaseline="middle";let l=t.font="bold "+n+"px sans-serif";var r,a,h,c,d,p,u,g,f;i.textFont&&(l="bold "+n+"px "+i.textFont),r=t,a=l,h=i.color,c=i.barColor,d=i.isText,p=o*e.scale,u=s*e.scale,g=2*e.scale,f=e.zoomLevel,c||(c="#000000"),a||(a="bold "+Math.round(12*f)+"px sans-serif"),h||(h="#ffffff"),g||(g=1),r.textAlign="center",r.font=a,r.strokeStyle=c,r.lineWidth=g,r.lineJoin="miter",r.miterLimit=2,r.strokeText(d,p,u),r.fillStyle=h,r.fillText(d,p,u)}(e,i,t,s,n):t.isLine?function(e,t,i,o,s){const n=i.w-e.viewX+.5|0,l=i.h-e.viewY+.5|0;t.lineWidth=i.lineWidth*e.scale,t.strokeStyle=i.color,t.globalAlpha=i.alpha,i.dashedLine?t.setLineDash([4,10]):t.setLineDash([]),t.beginPath(),t.moveTo(o*e.scale,s*e.scale),t.lineTo(n*e.scale,l*e.scale),t.stroke()}(e,i,t,s,n):t.isCircle?function(e,t,i,o,s){i.lineWidth>0?(t.lineWidth=i.lineWidth*e.scale,t.strokeStyle=i.color,i.dashedLine?t.setLineDash([4,10]):t.setLineDash([])):t.fillStyle=i.color,t.globalAlpha=i.alpha,t.beginPath(),e.isometricMode?t.ellipse(o*e.scale,s*e.scale,i.h*e.scale,i.h/2*e.scale,0,0,f):t.ellipse(o*e.scale,s*e.scale,i.h*e.scale,i.h*e.scale,0,0,f),i.lineWidth>0?t.stroke():t.fill()}(e,i,t,s,n):t.isSquare?function(e,t,i,o,s){t.fillStyle=i.color,t.globalAlpha=1,i.img&&(t.save(),t.globalCompositeOperation=i.img),e.isometricMode?(t.beginPath(),t.moveTo(o,s),t.lineTo(o+e.halfRelativeGridSize,s+e.quarterRelativeGridSize),t.lineTo(o,s+e.halfRelativeGridSize),t.lineTo(o-e.halfRelativeGridSize,s+e.quarterRelativeGridSize),t.fill()):t.fillRect(o*e.scale,s*e.scale,(e.relativeGridSize+1)*e.scale,(e.relativeGridSize+1)*e.scale),i.img&&t.restore()}(e,i,t,s,n):t.isBar?function(e,t,i,o,s){const n=i.barWidth*e.scale;let l=i.meterWidth*e.scale;l<0&&(l=0),t.globalAlpha=1,t.fillStyle="#000000",t.fillRect(o*e.scale,s*e.scale,n,6*e.scale),t.fillStyle=i.barColor,t.fillRect((o+1)*e.scale,(s+1)*e.scale,l,4*e.scale)}(e,i,t,s,n):(null!=t.alpha&&null!=t.alpha?i.globalAlpha=t.alpha:i.globalAlpha=1,t.segmentX>0?function(e,t,i,o,s){s+i.h<0||o+i.destSegX+e.halfRelativeGridSize<0||t.drawImage(i.img,i.segmentX,0,i.sW,i.sH,(o+i.destSegX)*e.scale,s*e.scale,(e.halfRelativeGridSize+1)*e.scale,i.h*e.scale)}(e,i,t,s,n):function(e,t,i,o,s,n){0!=i.angle&&(t.save(),t.translate(o+e.halfRelativeGridSize,s+e.halfRelativeGridSize),t.rotate(i.angle*v),o=-e.halfRelativeGridSize,s=-e.halfRelativeGridSize),i.img&&t.drawImage(i.img,o*e.scale,s*e.scale,i.w*e.scale,i.h*e.scale),0!=i.angle&&t.restore(),n&&E(e,n,i.img,i.tX,i.tY)}(e,i,t,s,n,o))}}else t.isBar||t.isLine||t.isSquare||E(e,o,t.img,t.tX,t.tY)}function I(e,t,i){if(i.alpha<=0)return void(i.cashed=!0);const o=i.x-e.viewX,s=i.y-e.viewY,n=20*e.zoomLevel;t.setLineDash([]),t.strokeStyle="#000000",t.lineWidth=1,t.fillStyle=i.color,t.textAlign="center",t.textBaseline="middle",t.font="bold "+n+"px sans-serif",t.save(),t.globalAlpha=i.alpha,t.fillText(i.text,o,s),t.strokeText(i.text,o,s),t.restore()}function E(e,t,i,o,s){if(!t)return;let n=Math.floor(o*e.gridSize)/2,l=(s-1)*e.gridSize/2-i.height/2;e.isometricMode&&(n=Math.floor((o-s)*e.halfRelativeGridSize)/2,l=(o+s)*e.quarterRelativeGridSize/2,n+=t.canvas.width/2),t.drawImage(i,n,l,i.width/2,i.height/2)}function O(e,t,i,o,s,n,l){if(!s||isNaN(s)||s<0)return;let r;if(e.isometricMode)return void(s>.8*e.relativeGridSize?(t.save(),t.transform(1,0,0,.5,0,0),r=t.createRadialGradient(i*e.scale,2*o*e.scale,0,i*e.scale,2*o*e.scale,s*e.scale),r.addColorStop(0,n),r.addColorStop(1,l),t.fillStyle=r,t.beginPath(),t.arc(i*e.scale,2*o*e.scale,s*e.scale,0,f),t.fill(),t.restore()):(r=t.createRadialGradient(i*e.scale,o*e.scale,0,i*e.scale,o*e.scale,s*e.scale),r.addColorStop(0,n),r.addColorStop(1,l),t.fillStyle=r,t.beginPath(),t.arc(i*e.scale,o*e.scale,s*e.scale,0,f),t.fill()));e.preRenderCanvas.height=2*s,e.preRenderCanvas.width=2*s,e.gradientFilterCanvas.height=2*s,e.gradientFilterCanvas.width=2*s;let a,h,c,d,p,u,g=[];if(!e.isometricMode)for(a=0;a<e.lightBlockers.length;a++)u=e.lightBlockers[a],h=i-u.x,c=o-u.y,d=Math.sqrt(h*h+c*c),d<=s+.05*s&&(u.d=d,g.push(u));if(u=null,e.isometricMode&&s>.8*e.relativeGridSize?(e.preRenderContext.save(),e.preRenderContext.transform(1,0,0,.5,0,0),r=t.createRadialGradient(s,2*s,0,s,2*s,s),r.addColorStop(0,n),r.addColorStop(1,l),e.preRenderContext.fillStyle=r,e.preRenderContext.beginPath(),e.preRenderContext.arc(s,2*s,s,0,f),e.preRenderContext.fill(),e.preRenderContext.restore()):(r=t.createRadialGradient(s,s,0,s,s,s),r.addColorStop(0,n),r.addColorStop(1,l),e.preRenderContext.fillStyle=r,e.preRenderContext.beginPath(),e.preRenderContext.arc(s,s,s,0,f),e.preRenderContext.fill()),e.isometricMode)return t.save(),t.globalCompositeOperation="lighten",t.drawImage(e.preRenderCanvas,i-s,o-s),void t.restore();let v=[],m=[];for(a=0;a<360;a++){const e=s+(s+.05*s)*Math.cos(a),t=s+(s+.05*s)*Math.sin(a);v.push({x:e,y:t})}for(;g.length>0;)q(e,g.pop(),s,m,i,o);let S=[];for(a=0,p=v.length;a<p;a++)Z(v[a],s,m,S);for(e.gradientFilterContext.fillStyle="rgba(0,0,0,.3)",e.gradientFilterContext.fillRect(0,0,e.gradientFilterCanvas.width,e.gradientFilterCanvas.height),e.gradientFilterContext.fillStyle="#ff0000",a=0,p=S.length;a<p;a++)e.gradientFilterContext.fillRect(S[a].x,S[a].y,e.relativeGridSize,e.relativeGridSize);for(v.sort(B),e.gradientFilterContext.beginPath(),e.gradientFilterContext.moveTo(v[0].x,v[0].y),a=1,p=v.length;a<p;a++)e.gradientFilterContext.lineTo(v[a].x,v[a].y);e.gradientFilterContext.closePath(),e.gradientFilterContext.fill(),e.preRenderContext.save(),e.preRenderContext.globalCompositeOperation="destination-in",e.preRenderContext.drawImage(e.gradientFilterCanvas,0,0),e.preRenderContext.restore(),t.save(),t.globalCompositeOperation="lighten",t.drawImage(e.preRenderCanvas,i-s,o-s),t.restore()}function B(e,t){return e.angle>t.angle?1:e.angle<t.angle?-1:void 0}function q(e,t,i,o,s,n){const l=Math.atan2(t.y-n,t.x-s),r=i+t.d*Math.cos(l),a=i+t.d*Math.sin(l),h={x:r,y:a},c={x:r+e.relativeGridSize,y:a},d={x:r,y:a+e.relativeGridSize},p={x:r+e.relativeGridSize,y:a+e.relativeGridSize};o.push({x1:h.x,y1:h.y,x2:c.x,y2:c.y,source:h}),o.push({x1:c.x,y1:c.y,x2:p.x,y2:p.y,source:h}),o.push({x1:d.x,y1:d.y,x2:p.x,y2:p.y,source:h}),o.push({x1:h.x,y1:h.y,x2:d.x,y2:d.y,source:h})}function Z(e,t,i,o){let s,n,l,r=99999999,a=null;for(let o=0,h=i.length;o<h;o++){const h=i[o],c=Q(t,t,e.x,e.y,h.x1,h.y1,h.x2,h.y2);c.onLine1&&c.onLine2&&(s=t-c.x,n=t-c.y,l=Math.sqrt(s*s+n*n),l<r&&(e.x=c.x,e.y=c.y,r=l,h.source&&(a=h.source)))}null!=a&&o.push(a),e.angle=Math.atan2(e.y-t,e.x-t)}function Q(e,t,i,o,s,n,l,r){let a,h,c,d,p,u={x:null,y:null,onLine1:!1,onLine2:!1};return a=(r-n)*(i-e)-(l-s)*(o-t),0==a||(h=t-n,c=e-s,d=(l-s)*h-(r-n)*c,p=(i-e)*h-(o-t)*c,h=d/a,c=p/a,u.x=e+h*(i-e),u.y=t+h*(o-t),h>0&&h<1&&(u.onLine1=!0),c>0&&c<1&&(u.onLine2=!0)),u}function N(e,t,i,o,s=0,n=!1,l=1){if(!e.drawQueue||null==t||null==t)return;if(e.instructionsRecieved=!0,!e.checkVisibility(i,o)&&!e.fullMapRenderCallback)return;const r=U(e,t,i,o,null);r.tX=i,r.tY=o,r.nearness=o,r.alpha=l,r.blocksLight=n,r.zIndex=s,e.isometricMode&&(r.nearness+=i),e.drawQueue.push(r)}function U(e,t,i,o,s){null!=s&&null!=s||(s=j(e)),s.img=t;let n=e.relativeGridSize,l=e.relativeGridSize;if(e.isometricMode){if(l=e.halfRelativeGridSize,t.width!=2*t.height){const i=t.width/e.relativeGridSize;l=t.height/i}const r=(i-o)*e.halfRelativeGridSize,a=(i+o)*e.quarterRelativeGridSize,h=r-e.halfRelativeGridSize,c=a+e.halfRelativeGridSize-l;s.x=h,s.y=c,s.w=n,s.h=l,s.nearness=i+o}else{if(t.width!=t.height){const i=t.height/t.width;l=e.relativeGridSize*i}n=Math.ceil(n),l=Math.ceil(l);const r=i*e.relativeGridSize,a=o*e.relativeGridSize+e.relativeGridSize-l;s.x=r,s.y=a,s.w=n,s.h=l}return s}function j(e){let t;return 0==x.length?t=new F:(t=x.pop(),t.x=0,t.y=0,t.img=null,t.w=0,t.h=0,t.alpha=null,t.isBar=!1,t.barWidth=0,t.meterWidth=0,t.barColor="#000000",t.isSquare=!1,t.isLine=!1,t.isCircle=!1,t.color="#000000",t.nearness=0,t.tileWidth=1,t.tileHeight=1,t.zIndex=0,t.altitude=0,t.segmentX=-1,t.cX=0,t.cY=0,t.destSegX=0,t.sW=0,t.sH=0,t.blocksLight=!1,t.lineWidth=1,t.angle=0,t.tX=0,t.tY=0,t.dashedLine=!1,t.isText=null,t.textFont=null),t.ro=e.renderOrder,e.renderOrder++,t}function $(e,t,i,o,s,n,l,r,a,h,c,d,p,u,g,f,v,m,S,w,x,y,z,C){if(!t)return;if(e.fullMapRenderCallback)return void N(e,t,i,o,c,!1,h);if(!e.checkVisibility(i,o))return;if(e.instructionsRecieved=!0,C=parseFloat(C),isNaN(C)&&(C=0),e.isometricMode&&s==i&&n==o&&!e.useFastRenderMode)return function(e,t,i,o,s,n,l,r,a,h,c,d,p,u,g,f,v,m,S,w,x,y,z,C){let G,R,X=t.width*S,Y=t.height*S;1!=e.zoomLevel&&(X*=e.zoomLevel,Y*=e.zoomLevel);const M=i+d-1,F=(M+(o+p-1))*e.quarterRelativeGridSize,T=(M-o)*e.halfRelativeGridSize,b=F+e.halfRelativeGridSize,L=T+e.halfRelativeGridSize;G=L-X,R=b-Y;const k=e.halfGridSize/S,P=Math.round(t.width/k);let H=0,D=0;for(let s=0;s<P;s++){const n=j(e),l=G+e.halfRelativeGridSize*s,g=l+e.halfRelativeGridSize;let v=i+o;for(let t=i;t<i+d;t++)for(let i=o;i<o+p;i++){const o=(t-i)*e.halfRelativeGridSize,s=o-e.halfRelativeGridSize;let n=o+e.halfRelativeGridSize;n>L&&(n=L);const r=t+i;n>=l&&s<=g&&r>v&&(v=r)}n.sW=k,n.sH=t.height,n.img=t,n.zIndex=c,C&&(0==s&&(K(e,i,o,c,d),R-=Math.round((C&e.gridSize)*e.zoomLevel)),v+=C),n.cX=i,n.cY=o,n.x=G,n.y=R,n.w=X,n.h=Y,n.tileWidth=d,n.tileHeight=p,n.alpha=h,n.nearness=v,n.segmentX=H,n.destSegX=D,H+=k,D+=e.halfRelativeGridSize,e.drawQueue.push(n),s==d-1&&J(e,o,G,R,X,Y,r,a,u,f,m,z,v,c)}return v&&_(e,v,x,w,G,R,X,Y,i+o,c,y),{x:G,y:R,w:X,h:Y}}(e,t,i,o,0,0,0,r,a,h,c,d,p,u,0,f,v,m,S,w,x,y,z,C);const G=j(e);let R,X;G.tX=i,G.tY=o,G.blocksLight=!1,G.angle=g,G.img=t,G.zIndex=c,G.tileHeight=p,G.tileWidth=d,G.alpha=h;let Y=t.width*S,M=t.height*S;1!=e.zoomLevel&&(Y*=e.zoomLevel,M*=e.zoomLevel);let F=o;if(e.isometricMode){const t=i+d-1,s=o+p-1;F=t+s;const n=(t+(s-m))*e.quarterRelativeGridSize,l=(t-(s-m))*e.halfRelativeGridSize,r=n+e.halfRelativeGridSize;R=l+e.halfRelativeGridSize-Y,X=r-M}else R=i*e.relativeGridSize,X=(o-m)*e.relativeGridSize+e.relativeGridSize-M;if(i!=s||o!=n){const t=e.twentiethGridSize*l;if(e.isometricMode){let e=i,l=o;s>i&&(R+=t/2,X+=t/4,e+=2),s<i&&(R-=t/2,X-=t/4,e++),n>o&&(R-=t/2,X+=t/4,l+=2),n<o&&(R+=t/2,X-=t/4,l++),F=e+l}else s>i&&(R+=t),s<i&&(R-=t),n>o&&(X+=t),n<o&&(X-=t)}return C>0&&(K(e,i,o,c,d),F+=C,X-=Math.round((C&e.gridSize)*e.zoomLevel)),G.x=R,G.y=X,G.w=Y,G.h=M,G.nearness=F,e.drawQueue.push(G),J(e,o,R,X,Y,M,r,a,u,f,m,z,F,c),v&&_(e,v,x,w,R,X,Y,M,F,c,y),{x:R,y:X,w:Y,h:M}}function J(e,t,i,o,s,n,l,r,a,h,c,d,p,u){let g=!1;if(l&&l>0){g=!0;const a=j(e);a.isBar=!0,a.x=i,a.y=o+n,d&&(a.y=(t-c+d)*e.relativeGridSize+e.relativeGridSize);let h=s;e.isometricMode||(h=Math.round(.7*s),a.x+=Math.round(.15*s)),a.barWidth=h,a.meterWidth=h*l-2,a.barColor=r,a.nearness=p+1,e.isometricMode&&a.nearness++,a.zIndex=u+1,e.aboveFoldDrawQueue.push(a)}if(null!=a){let t=i,l=o+n;if(g&&(l+=10),h){l=o+Math.round(n/2),l-=5;let e=0;for(const t of a)t.image?e+=20:e+=10;const r=Math.round(e/2);t=i+Math.round(s/2)-r}for(const i of a){const o=j(e);o.x=t,o.y=l,i.image?(o.img=i.image,o.w=16,o.h=16,o.y-=5,t+=10):(o.isBar=!0,o.barWidth=6,o.meterWidth=4,o.barColor=i.color),o.nearness=p+1,e.isometricMode&&o.nearness++,o.zIndex=u+1,e.aboveFoldDrawQueue.push(o),t+=10}}}function _(e,t,i,o,s,n,l,r,a,h,c){const d=j(e);d.isText=t,d.textFont=i,d.lineWidth=o,d.x=s+Math.round(l/2),d.y=n+Math.round(r/2),d.color="#ffffff",d.barColor="#000000",c&&(d.y+=c*e.relativeGridSize),d.nearness=a+1,e.isometricMode&&d.nearness++,d.zIndex=h+1,e.drawQueue.push(d)}function K(e,t,i,o,s){const n=j(e);let l=i;e.isometricMode?(l+=t,n.x=(t-i)*e.halfRelativeGridSize,n.y=(t+i)*e.quarterRelativeGridSize,n.y+=e.quarterRelativeGridSize):(n.x=t*e.relativeGridSize,n.y=i*e.relativeGridSize,n.x+=e.halfRelativeGridSize,n.y+=e.halfRelativeGridSize),n.isCircle=!0,n.color="rgba(0,0,0,0.25)",n.alpha=1,n.lineWidth=0,n.zIndex=o,n.h=s*e.relativeGridSize/4,n.nearness=l+.1,e.drawQueue.push(n)}function ee(e){e.style.imageRendering="pixelated";const t=e.getContext("2d");t.imageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1}const te={getInstance:R,globalResize:k,hexToRgb:P,Scroll2dEngine:X,Chevron:T,pixelateCanvas:ee};requestAnimationFrame((function e(t){requestAnimationFrame(e),null==C&&(C=t);const i=t-C;C=t;let o=i/S;G=1e3/i,isNaN(o)&&(o=1);for(const e in w){const i=w[e];i.render(),i.update(t,o)}}));var ie=t.cL,oe=t.I1,se=t.Ay,ne=t.iE,le=t.yD,re=t.E2,ae=t.Db;export{ie as Chevron,oe as Scroll2dEngine,se as default,ne as getInstance,le as globalResize,re as hexToRgb,ae as pixelateCanvas};